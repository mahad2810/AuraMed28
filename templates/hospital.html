<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Light Theme (Default) */
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --secondary-color-dark: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --background-color: #f5f7fa;
            --card-background: #fff;
            --header-bg: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --tab-active-bg: #3498db;
            --tab-active-color: #fff;
            --tab-hover-bg: #f0f0f0;
            --section-btn-bg: #f0f0f0;
            --section-btn-active-bg: #3498db;
            --section-btn-active-color: #fff;
            --section-btn-hover-bg: #e0e0e0;
            --border-color: #ddd;
            --input-bg: #fff;
            --input-bg-hover: #f5f5f5;
            --hover-bg: #f5f5f5;
            --card-bg: #fff;
        }
        

        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--box-shadow);
            position: relative;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 2rem;
            width: 100%;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
        }
        
        .header .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header .logo-img {
            width: 50px;
            height: auto;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .header .logo-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }
        
        .details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .details h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .details p {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .details .edit-btn {
            background-color: var(--light-color);
            color: var(--primary-color);
            border: none;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: var(--transition);
            margin-top: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .details .edit-btn:hover {
            background-color: white;
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        .logout-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            padding: 0.6rem 1.2rem;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .logout-form {
            display: inline;
        }
        
        /* Content Styles */
        .content {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }
        

        
        /* Section Tabs Styling */
        .section-header {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }
        
        .section-btn {
            background: var(--section-btn-bg);
            border: none;
            padding: 1rem 2rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 1.1rem;
            box-shadow: var(--box-shadow);
        }
        
        .section-btn i {
            font-size: 1.2rem;
        }
        
        .section-btn:hover {
            background-color: var(--section-btn-hover-bg);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .section-btn.active {
            background-color: var(--section-btn-active-bg);
            color: var(--section-btn-active-color);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
        }
        
        /* Tabs Styling */
        .tabs-container {
            display: flex;
            justify-content: center;
            background: var(--card-background);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        
        .section-tabs {
            display: none;
            gap: 0.5rem;
        }
        
        .section-tabs.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tab {
            cursor: pointer;
            padding: 0.8rem 1.5rem;
            color: var(--text-color);
            border: none;
            background: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            border-radius: var(--border-radius);
            white-space: nowrap;
        }
        
        .tab:hover {
            background: var(--tab-hover-bg);
        }
        
        .tab.active {
            background: var(--tab-active-bg);
            color: var(--tab-active-color);
        }
        
        .tab-content {
            display: none;
            padding: 1.5rem;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Table Styles */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            background-color: var(--card-background);
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }
        
        .table-container:hover {
            box-shadow: var(--box-shadow);
            transform: translateY(-3px);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 1rem;
            text-align: left;
        }
        
        table th {
            background-color: var(--table-header-bg);
            color: white;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        table tr {
            border-bottom: 1px solid var(--border-color);
        }
        
        table tr:last-child {
            border-bottom: none;
        }
        
        table tr:hover td {
            background-color: var(--table-hover-bg);
            transition: background-color 0.2s ease;
        }
        
        table td .action-btn {
            padding: 0.4rem 0.6rem;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            margin-right: 0.3rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            transition: var(--transition);
        }
        
        table td .view-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        table td .edit-btn {
            background-color: var(--secondary-color);
            color: white;
        }
        
        table td .delete-btn {
            background-color: var(--accent-color);
            color: white;
        }
        
        table td .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        /* Button Styles */
        .action-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .action-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        .add-slot-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            cursor: pointer;
            padding: 0.7rem 1.2rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: var(--transition);
            margin-bottom: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .add-slot-btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: var(--card-background);
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s;
            overflow: hidden;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            background-color: var(--card-background);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .close {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .close:hover {
            color: #ddd;
        }
        .dropdown {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        .dropdown:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .submit-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .submit-btn:hover {
            background-color: var(--secondary-color);
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }

        /* Additional styles to complement your UI */
        .inv-header {
            text-align: center;
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            font-weight: 500;
            box-shadow: var(--box-shadow);
        }
        
        .inv-add-item-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 0.7rem 1.2rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 1rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .inv-add-item-btn:hover {
            background-color: var(--success-color);
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
    
        .inv-container {
        padding: 1.5rem;
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 1.5rem;
    }
    
    h2 {
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-weight: 600;
        font-size: 1.5rem;
    }
    
    .inv-table-container {
        max-height: 400px;
        overflow-y: auto;
        border-radius: var(--border-radius);
        background-color: var(--card-background);
        margin-bottom: 1.5rem;
        box-shadow: var(--box-shadow);
    }
    
    .inv-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .inv-table th, .inv-table td {
        padding: 1rem;
        text-align: left;
    }
    
    .inv-table tr {
        border-bottom: 1px solid #eee;
    }
    
    .inv-table tr:last-child {
        border-bottom: none;
    }
    
    .inv-table th {
        background-color: var(--primary-color);
        color: white;
        position: sticky;
        top: 0;
        font-weight: 500;
    }
    
    .inv-table tr:hover td {
        background-color: var(--table-hover-bg);
    }
    
    .inv-edit-btn, .inv-delete-btn {
        padding: 0.5rem 0.8rem;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        margin-right: 0.5rem;
    }
    
    .inv-edit-btn {
        background-color: var(--warning-color);
        color: white;
    }
    
    .inv-edit-btn:hover {
        background-color: #e67e22;
        transform: translateY(-2px);
        box-shadow: var(--box-shadow);
    }
    
    .inv-delete-btn {
        background-color: var(--danger-color);
        color: white;
    }
    
    .inv-delete-btn:hover {
        background-color: #c0392b;
        transform: translateY(-2px);
        box-shadow: var(--box-shadow);
    }
    
    /* Inventory Modal Styles */
    .inv-modal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        animation: fadeIn 0.3s;
    }
    
    .inv-modal-content {
        background-color: var(--card-background);
        margin: 5% auto;
        padding: 0;
        width: 90%;
        max-width: 500px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        animation: slideIn 0.3s;
        overflow: hidden;
    }
    
    .inv-modal-header {
        padding: 1rem 1.5rem;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .inv-modal-body {
        padding: 1.5rem;
    }
    
    .inv-modal-footer {
        padding: 1rem 1.5rem;
        background-color: var(--card-background);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }
    
    .inv-close {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .inv-close:hover {
        color: #ddd;
    }
    
    .inv-save-btn {
        background-color: var(--success-color);
        color: white;
        padding: 0.7rem 1.2rem;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 500;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .inv-save-btn:hover {
        background-color: #27ae60;
        transform: translateY(-2px);
        box-shadow: var(--box-shadow);
    }
    /* Search Input Styles */
.search-input {
    width: 100%;
    max-width: 300px;
    padding: 0.8rem 1rem;
    margin: 0.8rem 0;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 0.9rem;
    font-family: 'Poppins', sans-serif;
    outline: none;
    transition: var(--transition);
    background-color: var(--input-bg);
    color: var(--text-color);
}

.search-input:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.search-input::placeholder {
    color: var(--text-color);
    opacity: 0.6;
    font-style: italic;
}

/* Tabs Styling - Already defined in the main CSS */
h2 { 
    color: var(--primary-color);
    margin-bottom: 1rem;
    font-weight: 600;
    font-size: 1.5rem;
}

        /* Slots Tab Styling */
        .section-title {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 2rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .slot-section {
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .slot-section:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .section-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
        }
        
        .add-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 0.7rem 1.2rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .add-btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        .slots-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .slots-table th, .slots-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .slots-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .slots-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            padding: 1rem;
            text-align: left;
            position: relative;
        }
        
        .slots-table th i {
            margin-right: 0.5rem;
        }
        
        .slots-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .slots-table tr:last-child td {
            border-bottom: none;
        }
        
        .slots-table tr:hover td {
            background-color: #f8f9fa;
        }
        
        .filter-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.8rem 1rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }
        
        .filter-container:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .filter-container label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-container select {
            flex: 1;
            max-width: 300px;
        }
        
        /* Call Management Styling */
        .call-management-container { 
            padding: 1.5rem; 
            background: white; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
            margin-bottom: 1.5rem;
        }
        
        .meeting-section { 
            margin-bottom: 1.5rem; 
            padding: 1.5rem; 
            border-radius: var(--border-radius); 
            background: #f8f9fa; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
        }
        
        .meeting-section h3 { 
            margin-top: 0; 
            color: var(--primary-color); 
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .meeting-section p { 
            margin: 0.5rem 0; 
            color: var(--text-color); 
            font-size: 0.9rem;
        }
        
        .create-room-form { 
            display: none; 
            padding: 1.5rem; 
            background: white; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
            margin-bottom: 1.5rem;
        }
        
        .create-room-form label { 
            display: block; 
            margin-bottom: 0.5rem; 
            color: var(--text-color); 
            font-weight: 500; 
            font-size: 0.9rem;
        }
        
        .create-room-form input { 
            width: 100%; 
            padding: 0.8rem 1rem; 
            margin-bottom: 1rem; 
            border: 1px solid #ddd; 
            border-radius: var(--border-radius); 
            font-size: 0.9rem; 
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
        }
        
        .create-room-form input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .call-button { 
            background: var(--secondary-color); 
            color: white; 
            border: none; 
            padding: 0.8rem 1.5rem; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 500; 
            transition: var(--transition); 
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .call-button:hover { 
            background: var(--secondary-color); 
            opacity: 0.9;
            transform: translateY(-2px); 
            box-shadow: var(--box-shadow);
        }
        
        /* Patient Management Styling */
        .patient-management-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            padding: 1rem;
        }

        @media (min-width: 1200px) {
            .patient-management-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .patient-form-section, .patient-list-section {
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .patient-form-section:hover, .patient-list-section:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }
        
        .patient-form-section h3, .patient-list-section h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .patient-form-section h3 i, .patient-list-section h3 i {
            color: var(--primary-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--input-bg);
            color: var(--text-color);
            width: 100%;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(22, 33, 62, 0.2);
            outline: none;
            background-color: var(--input-bg);
        }
        
        .form-group input:hover, .form-group select:hover, .form-group textarea:hover {
            border-color: var(--secondary-color);
        }
        
        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-group label i {
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .patient-form-section .submit-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--box-shadow);
        }
        
        .patient-form-section .submit-btn:hover {
            background-color: var(--secondary-color-dark);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }

        .reset-btn {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .reset-btn:hover {
            background-color: var(--input-bg-hover);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        /* Call Modal Styling */
        .call-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            z-index: 9999; /* Ensures it's above everything */
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        
        .call-modal iframe { 
            width: 100%; 
            height: 92%; 
            border: none; 
            display: block;
        }
        
        .call-modal .close-button { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: var(--danger-color); 
            color: white; 
            border: none; 
            padding: 0.6rem 1rem; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 500; 
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 10000;
        }
        
        .call-modal .close-button:hover { 
            background: #c0392b; 
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        /* Dashboard Styles */
        .hospital-details-card {
            background-color: var(--card-background);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }

        .hospital-info h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .hospital-info p {
            margin: 8px 0;
            font-size: 1rem;
            color: var(--text-color);
        }

        .hospital-info i {
            width: 20px;
            color: var(--primary-color);
            margin-right: 10px;
        }

        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-card {
            background-color: var(--card-background);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }

        .metric-icon {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .metric-content {
            flex: 1;
        }

        .metric-content h3 {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .metric-trend {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }

        .metric-trend.positive {
            color: var(--success-color);
        }

        .metric-trend.negative {
            color: var(--danger-color);
        }

        .metric-trend.neutral {
            color: var(--text-muted);
        }

        .dashboard-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .dashboard-section {
            background-color: var(--card-background);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--box-shadow);
        }

        .dashboard-section h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .quick-access-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .quick-access-btn {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            color: var(--text-color);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .quick-access-btn i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--secondary-color);
        }

        .quick-access-btn:hover {
            background-color: var(--hover-bg);
            transform: translateY(-3px);
        }

        .prediction-content {
            padding: 10px 0;
        }

        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .prediction-header h4 {
            font-size: 1rem;
            color: var(--text-color);
            font-weight: normal;
        }

        .overall-forecast {
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .prediction-bars {
            margin-bottom: 15px;
        }

        .prediction-time-slot {
            margin-bottom: 12px;
        }

        .time-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .prediction-bar-container {
            width: 100%;
            height: 25px;
            background-color: var(--background-color);
            border-radius: 5px;
            margin-bottom: 5px;
            overflow: hidden;
        }

        .prediction-bar {
            height: 100%;
            border-radius: 5px;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 0.85rem;
            font-weight: bold;
            transition: width 0.5s ease-in-out;
        }

        .prediction-bar.high {
            background-color: var(--danger-color);
        }

        .prediction-bar.medium {
            background-color: var(--warning-color);
        }

        .prediction-bar.low {
            background-color: var(--success-color);
        }

        .view-all-link {
            text-align: right;
        }

        .view-all-link a {
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .view-all-link a:hover {
            text-decoration: underline;
        }

        /* Slots Tabs Styles */
        .slots-tabs {
            display: flex;
            background-color: var(--card-background);
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .slots-tab {
            padding: 12px 20px;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            border-bottom: 3px solid transparent;
        }

        .slots-tab i {
            margin-right: 8px;
            color: var(--secondary-color);
        }

        .slots-tab:hover {
            background-color: var(--tab-hover-bg);
        }

        .slots-tab.active {
            border-bottom: 3px solid var(--secondary-color);
            font-weight: bold;
        }

        .slots-tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .slots-tab-content.active {
            display: block;
        }

        /* Bed Availability Styles */
        .bed-view-toggle {
            display: flex;
            gap: 10px;
        }

        .bed-view-btn {
            padding: 8px 15px;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bed-view-btn.active {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .bed-availability-legend {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-dot.available {
            background-color: #28a745;
        }

        .status-dot.occupied {
            background-color: #dc3545;
        }

        .status-dot.reserved {
            background-color: #ffc107;
        }

        .status-dot.maintenance {
            background-color: #6c757d;
        }

        .bed-availability-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 20px;
        }

        .floor-container h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .beds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .bed-card {
            background-color: var(--card-background);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease;
        }

        .bed-card:hover {
            transform: translateY(-5px);
        }

        .bed-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .bed-icon.available {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .bed-icon.occupied {
            background-color: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .bed-icon.reserved {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .bed-icon.maintenance {
            background-color: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }

        .bed-details {
            flex: 1;
        }

        .bed-id {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 3px;
            color: var(--text-color);
        }

        .bed-type {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .bed-status {
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .bed-status.available {
            color: #28a745;
        }

        .bed-status.occupied {
            color: #dc3545;
        }

        .bed-status.reserved {
            color: #ffc107;
        }

        .bed-status.maintenance {
            color: #6c757d;
        }

        .bed-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background-color: var(--card-background);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--box-shadow);
        }

        .summary-item {
            flex: 1;
            min-width: 100px;
            text-align: center;
        }

        .summary-label {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .summary-value.available {
            color: #28a745;
        }

        .summary-value.occupied {
            color: #dc3545;
        }

        .summary-value.reserved {
            color: #ffc107;
        }
        
        /* OPD Prediction Styling - Dark Theme */
        .dashboard-section {
            background-color: #1e2130;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .dashboard-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #e0e0e0;
            font-size: 1.2rem;
        }
        
        .prediction-content {
            padding: 10px 0;
        }
        
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .prediction-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
            color: #e0e0e0;
        }
        
        .overall-forecast {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .overall-forecast.high-volume {
            background-color: rgba(220, 53, 69, 0.3);
            color: #ff6b6b;
        }
        
        .overall-forecast.medium-volume {
            background-color: rgba(255, 193, 7, 0.3);
            color: #ffe066;
        }
        
        .overall-forecast.low-volume {
            background-color: rgba(40, 167, 69, 0.3);
            color: #69db7c;
        }
        
        .prediction-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .prediction-time-slot {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .time-label {
            font-size: 0.9rem;
            color: #b0b0b0;
        }
        
        .prediction-bar-container {
            width: 100%;
            height: 25px;
            background-color: #2a2a2a;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .prediction-bar {
            height: 100%;
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #f0f0f0;
            transition: width 0.5s ease-in-out;
            white-space: nowrap;
            position: relative;
            z-index: 1;
        }
        
        .prediction-bar.high {
            background-color: #8b0000;
        }
        
        .prediction-bar.medium {
            background-color: #8b6d00;
            color: #f0f0f0;
        }
        
        .prediction-bar.low {
            background-color: #006400;
        }
        
        .view-all-link {
            margin-top: 15px;
            text-align: right;
        }
        
        .view-all-link a {
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .view-all-link a:hover {
            text-decoration: underline;
        }

        .summary-value.maintenance {
            color: #6c757d;
        }
        
        /* Health Monitoring & ECG Styles */
        .monitoring-controls {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }
        
        .monitoring-dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        .vital-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .vital-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .vital-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .vital-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-right: 1.5rem;
        }
        
        .vital-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: var(--text-color);
        }
        
        .vital-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
        }
        
        .vital-status {
            font-size: 0.9rem;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            display: inline-block;
            background: #e6f7ff;
            color: #0070f3;
        }
        
        .vital-status.warning {
            background: #fff7e6;
            color: #fa8c16;
        }
        
        .vital-status.danger {
            background: #fff1f0;
            color: #f5222d;
        }
        
        .monitoring-charts {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
        }
        
        .chart-container h3 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }
        
        .chart {
            height: 300px;
            width: 100%;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .placeholder-chart {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-style: italic;
            background: var(--input-bg);
            border-radius: var(--border-radius);
        }
        
        .monitoring-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .action-btn.danger {
            background-color: var(--danger-color);
        }
        
        .action-btn.danger:hover {
            background-color: #c0392b;
        }
        
        /* ECG Specific Styles */
        .ecg-dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        .ecg-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
        }
        
        .ecg-container h3 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }
        
        .ecg-chart {
            height: 300px;
            width: 100%;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .ecg-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            text-align: center;
        }
        
        .stat-card h4 {
            margin: 0 0 1rem 0;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .ecg-analysis {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
        }
        
        .ecg-analysis h3 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }
        
        .analysis-result {
            padding: 1.5rem;
            background: var(--input-bg);
            border-radius: var(--border-radius);
            color: var(--text-color);
        }
        
        /* Responsive adjustments */
        @media (min-width: 1200px) {
            .monitoring-dashboard,
            .ecg-dashboard {
                grid-template-columns: 2fr 1fr;
            }
            
            .monitoring-charts {
                grid-column: 1 / -1;
            }
            
            .ecg-container {
                grid-column: 1 / -1;
            }
        }
    </style>
    
    
</head>
<body>

    <div class="header">
        <div class="header-content">
            <div class="logo">
                <img src="static/AuraMedlogo.png" alt="AuraMed Logo" class="logo-img">
                <span class="logo-name">AuraMed</span>
            </div>
            <div class="hospital-title">
                <h1 id="hospital-name">Hospital Name</h1>
            </div>
            <div class="header-actions">

                <form action="{{ url_for('logout') }}" method="POST" class="logout-form">
                    <button type="submit" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="content">
        <div class="section-header">
            <button class="section-btn active" onclick="openSection('patientManagement')"><i class="fas fa-user-injured"></i> Patient Management</button>
            <button class="section-btn" onclick="openSection('hospitalManagement')"><i class="fas fa-hospital"></i> Hospital Management</button>
        </div>
        
        <div class="tabs-container">
            <!-- Patient Management Tabs -->
            <div id="patientManagementTabs" class="section-tabs active">
                <button class="tab active" onclick="openTab('patientsManagement')"><i class="fas fa-procedures"></i> Patients</button>
                <button class="tab" onclick="openTab('patientsDailyReport')"><i class="fas fa-notes-medical"></i> Daily Reports</button>
                <button class="tab" onclick="openTab('healthMonitoring')"><i class="fas fa-heartbeat"></i> Health Monitoring</button>
                <button class="tab" onclick="openTab('patientECG')"><i class="fas fa-wave-square"></i> ECG Monitoring</button>
            </div>
            
            <!-- Hospital Management Tabs -->
            <div id="hospitalManagementTabs" class="section-tabs">
                <button class="tab" onclick="openTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                <button class="tab" onclick="openTab('appointmentTest')"><i class="fas fa-calendar-check"></i> Appointments & Tests</button>
                <button class="tab" onclick="openTab('availableSlots')"><i class="fas fa-clock"></i> Available Slots</button>
                <button class="tab" onclick="openTab('inventoryManagement')"><i class="fas fa-boxes"></i> Inventory</button>
                <button class="tab" onclick="openTab('callManagement')"><i class="fas fa-video"></i> Call Management</button>
                <button class="tab admin-only" onclick="openTab('staffManagement')"><i class="fas fa-users"></i> Staff Management</button>
            </div>
        </div>
    
    <div id="appointmentTest" class="tab-content active">
    
        <h2>Appointments</h2>
<div class="table-container">
    <h3>Ongoing Appointments</h3>
    <table>
        <thead>
            <tr>
                <th>Patient Name</th>
                <th>Doctor Name</th>
                <th>Specialization</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="ongoing-appointments-table"></tbody>
    </table>

    <h3>Completed Appointments</h3>
    <table>
        <thead>
            <tr>
                <th>Patient Name</th>
                <th>Doctor Name</th>
                <th>Specialization</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="completed-appointments-table"></tbody>
    </table>
</div>

<h2>Tests</h2>
<div class="table-container">
    <h3>Ongoing Tests</h3>
    <table>
        <thead>
            <tr>
                <th>Patient Name</th>
                <th>Doctor Name</th>
                <th>Test Type</th>
                <th>Test ID</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="ongoing-tests-table"></tbody>
    </table>

    <h3>Completed Tests</h3>
    <table>
        <thead>
            <tr>
                <th>Patient Name</th>
                <th>Doctor Name</th>
                <th>Test Type</th>
                <th>Test ID</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="completed-tests-table"></tbody>
    </table>
</div>

</div>
    
    
    <!-- Dashboard -->
<div id="dashboard" class="tab-content">
    <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> Hospital Dashboard</h2>
    
    <div class="hospital-details-card">
        <div class="hospital-info">
            <h3 id="hospital-name">Hospital Name</h3>
            <p><i class="fas fa-phone"></i> <span id="phone">123-456-7890</span></p>
            <p><i class="fas fa-map-marker-alt"></i> <span id="address">123 Main Street, City</span></p>
            <p><i class="fas fa-envelope"></i> <span id="email">info@hospital.com</span></p>
            <button class="edit-btn" onclick="makeEditable()"><i class="fas fa-edit"></i> Edit</button>
        </div>
    </div>
    
    <div class="dashboard-metrics">
        <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-user-injured"></i></div>
            <div class="metric-content">
                <h3>Total OPD Patients</h3>
                <div class="metric-value">127</div>
                <div class="metric-trend positive">+12% from yesterday</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-bed"></i></div>
            <div class="metric-content">
                <h3>Available Beds</h3>
                <div class="metric-value">43/120</div>
                <div class="metric-trend negative">-8% from last week</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-boxes"></i></div>
            <div class="metric-content">
                <h3>Inventory Items</h3>
                <div class="metric-value">872</div>
                <div class="metric-trend positive">+5 items new in stock</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-procedures"></i></div>
            <div class="metric-content">
                <h3>Current Admissions</h3>
                <div class="metric-value">77</div>
                <div class="metric-trend neutral">0% occupancy rate</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-vial"></i></div>
            <div class="metric-content">
                <h3>Tests</h3>
                <div class="metric-value">0</div>
                <div class="metric-trend neutral">0% from last week</div>
            </div>
        </div>
    </div>
    
    <div class="dashboard-sections">
        <div class="dashboard-section">
            <h3>Quick Access</h3>
            <div class="quick-access-buttons">
                <button class="quick-access-btn" onclick="openTab('appointmentTest')"><i class="fas fa-calendar-check"></i> OPD Queue</button>
                <button class="quick-access-btn" onclick="openTab('availableSlots')"><i class="fas fa-bed"></i> Bed Availability</button>
                <button class="quick-access-btn" onclick="openTab('inventoryManagement')"><i class="fas fa-boxes"></i> Inventory</button>
                <button class="quick-access-btn" onclick="openTab('patientsManagement')"><i class="fas fa-user-injured"></i> Admissions</button>
            </div>
        </div>
        
        <div class="dashboard-section">
            <h3>OPD Prediction</h3>
            <div class="prediction-content">
                <div class="prediction-header">
                    <h4>Predicted patient volume for today</h4>
                    <div class="overall-forecast" id="overall-forecast">Loading...</div>
                </div>
                <div class="prediction-bars" id="prediction-bars">
                    <div class="prediction-time-slot">
                        <div class="time-label">Morning (9AM-12PM)</div>
                        <div class="prediction-bar-container">
                            <div class="prediction-bar" id="morning-bar">Loading...</div>
                        </div>
                    </div>
                    <div class="prediction-time-slot">
                        <div class="time-label">Afternoon (12PM-4PM)</div>
                        <div class="prediction-bar-container">
                            <div class="prediction-bar" id="afternoon-bar">Loading...</div>
                        </div>
                    </div>
                    <div class="prediction-time-slot">
                        <div class="time-label">Evening (4PM-8PM)</div>
                        <div class="prediction-bar-container">
                            <div class="prediction-bar" id="evening-bar">Loading...</div>
                        </div>
                    </div>
                </div>
                <div class="view-all-link"><a href="#" onclick="fetchOPDPrediction(true); return false;">Refresh prediction </a></div>
            </div>
        </div>
    </div>
</div>

<!-- Available Slots Management -->
<div id="availableSlots" class="tab-content">
    <h2 class="section-title"><i class="fas fa-calendar-alt"></i> Available Slots Management</h2>
    
    <!-- Slots Navigation Tabs -->
    <div class="slots-tabs">
        <button class="slots-tab active" onclick="openSlotsTab('doctorSlots')"><i class="fas fa-user-md"></i> Doctors</button>
        <button class="slots-tab" onclick="openSlotsTab('bedSlots')"><i class="fas fa-bed"></i> Beds</button>
        <button class="slots-tab" onclick="openSlotsTab('testSlots')"><i class="fas fa-vial"></i> Tests</button>
    </div>

    <!-- Doctor Slots -->
    <div id="doctorSlots" class="slots-tab-content active">
        <div class="section-header">
            <h2><i class="fas fa-user-md"></i> Doctor Availability</h2>
            <button class="action-btn add-btn" onclick="openAddDoctorModal()"><i class="fas fa-plus"></i> Add New Doctor</button>
        </div>
        <div class="table-container">
            <table class="slots-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-user"></i> Doctor Name</th>
                        <th><i class="fas fa-stethoscope"></i> Specialization</th>
                        <th><i class="fas fa-calendar-check"></i> Availability</th>
                        <th><i class="fas fa-cog"></i> Actions</th>
                    </tr>
                </thead>
                <tbody id="doctors-table">
                    <!-- Rows will be dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bed Slots -->
    <div id="bedSlots" class="slots-tab-content">
        <div class="section-header">
            <h2><i class="fas fa-bed"></i> Bed Availability</h2>
            <div class="bed-view-toggle">
                <button class="bed-view-btn active" onclick="toggleBedView('byFloor')">By Floor</button>
                <button class="bed-view-btn" onclick="toggleBedView('byWard')">By Ward</button>
            </div>
        </div>
        
        <div class="bed-availability-legend">
            <div class="legend-item"><span class="status-dot available"></span> Available</div>
            <div class="legend-item"><span class="status-dot occupied"></span> Occupied</div>
            <div class="legend-item"><span class="status-dot reserved"></span> Reserved</div>
            <div class="legend-item"><span class="status-dot maintenance"></span> Maintenance</div>
        </div>
        
        <div class="bed-availability-container">
            <!-- Bed data will be loaded dynamically -->
            <div class="bed-summary">
                <div class="summary-item">
                    <div class="summary-label">Total Beds</div>
                    <div class="summary-value" id="total-beds">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Available</div>
                    <div class="summary-value" id="available-beds">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Occupied</div>
                    <div class="summary-value" id="occupied-beds">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Reserved</div>
                    <div class="summary-value" id="reserved-beds">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Maintenance</div>
                    <div class="summary-value" id="maintenance-beds">0</div>
                </div>
            </div>
            <!-- Floor containers will be added dynamically -->
        </div>

        
        <div class="bed-summary">
            <div class="summary-item">
                <div class="summary-label">Total Beds</div>
                <div class="summary-value">120</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Available</div>
                <div class="summary-value available">43</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Occupied</div>
                <div class="summary-value occupied">52</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Reserved</div>
                <div class="summary-value reserved">15</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Maintenance</div>
                <div class="summary-value maintenance">10</div>
            </div>
        </div>
    </div>

    <!-- Test Slots -->
    <div id="testSlots" class="slots-tab-content">
        <div class="section-header">
            <h2><i class="fas fa-vial"></i> Test Slot Availability</h2>
            <button class="action-btn add-btn" onclick="openModal()"><i class="fas fa-plus"></i> Add/Update Slot</button>
        </div>
        <div class="filter-container">
            <label for="testCategoryFilter"><i class="fas fa-filter"></i> Filter by Test Category:</label>
            <select id="testCategoryFilter" class="dropdown">
                <option value="" selected>All Categories</option>
                <option value="Blood Tests">Blood Tests</option>
                <option value="Prenatal and Pregnancy Tests">Prenatal and Pregnancy Tests</option>
                <!-- Add other categories -->
            </select>
        </div>
        <div class="table-container">
            <table class="slots-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-tags"></i> Test Category</th>
                        <th><i class="fas fa-flask"></i> Test Name</th>
                        <th><i class="fas fa-dollar-sign"></i> Price</th>
                        <th><i class="fas fa-calendar-day"></i> Date</th>
                        <th><i class="fas fa-clock"></i> Time Slots</th>
                        <th><i class="fas fa-cog"></i> Actions</th>
                    </tr>
                </thead>
                <tbody id="test-availability-table">
                    <!-- Rows will be dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>

<!-- Staff Management Tab -->
<div id="staffManagement" class="tab-content">
    <h2><i class="fas fa-users"></i> Staff Management</h2>
    <div class="staff-management-container">
        <!-- Add Staff Form -->
        <div class="add-staff-section">
            <h3><i class="fas fa-user-plus"></i> Add New Staff Member</h3>
            <form id="add-staff-form" class="staff-form">
                <div class="form-group">
                    <label for="staffName"><i class="fas fa-user"></i> Name:</label>
                    <input type="text" id="staffName" name="staffName" required placeholder="Enter staff name">
                </div>
                <div class="form-group">
                    <label for="staffEmail"><i class="fas fa-envelope"></i> Email:</label>
                    <input type="email" id="staffEmail" name="staffEmail" required placeholder="Enter staff email">
                </div>
                <div class="form-group">
                    <label for="staffPassword"><i class="fas fa-lock"></i> Password:</label>
                    <input type="password" id="staffPassword" name="staffPassword" required placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label for="staffRole"><i class="fas fa-user-tag"></i> Role:</label>
                    <select id="staffRole" name="staffRole" required>
                        <option value="nurse">Nurse</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="submit-btn"><i class="fas fa-plus-circle"></i> Add Staff</button>
                    <button type="reset" class="reset-btn"><i class="fas fa-undo"></i> Reset</button>
                </div>
            </form>
        </div>

        <!-- Staff List -->
        <div class="staff-list-section">
            <h3><i class="fas fa-list"></i> Staff Members</h3>
            <div class="filter-container">
                <label for="staffSearch"><i class="fas fa-search"></i></label>
                <input type="text" id="staffSearch" class="search-input" placeholder="Search staff..." onkeyup="searchTable('staffTable', this.value)">
            </div>
            <div class="table-container">
                <table id="staffTable" class="slots-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staff-table-body">
                        <!-- Staff members will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

</div>


 <!-- Modal for Adding a New Doctor -->
 <div id="add-doctor-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close" onclick="closeAddDoctorModal()">&times;</span>
            <h3>Add New Doctor</h3>
        </div>
        <div class="modal-body">
            <form id="add-doctor-form">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required><br><br>

                <label for="specialization">Specialization:</label>
                <input type="text" id="specialization" name="specialization" required><br><br>

                <label for="phone_number">Phone Number:</label>
                <input type="text" id="phone_number" name="phone_number" required><br><br>

                <label for="hospital">Hospital:</label>
                <input type="text" id="hospital" name="hospital" required><br><br>

                <label for="availability">Availability:</label>
                <div id="availability-container">
                    <input type="date" id="availability-date" required>
                    <select id="availability-time">
                        <option value="08:00">08:00 AM</option>
                        <option value="09:00">09:00 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="14:00">02:00 PM</option>
                        <option value="15:30">03:30 PM</option>
                    </select>
                    <button type="button" onclick="addAvailability()">Add</button>
                </div>
                <ul id="availability-list"></ul><br><br>

                <label for="degrees">Degrees:</label>
                <input type="text" id="degrees" name="degrees" placeholder="Comma-separated (e.g., MBBS, MS)" required><br><br>

                <label for="experience">Experience:</label>
                <textarea id="experience" name="experience" placeholder="Enter experience details" required></textarea><br><br>

                <label for="achievements">Achievements:</label>
                <textarea id="achievements" name="achievements" placeholder="Comma-separated achievements" required></textarea><br><br>

                <button type="button" class="submit-btn" onclick="addDoctor()">Submit</button>
            </form>
        </div>
    </div>
</div>


<!-- Modal for adding/updating slots -->
<div class="modal" id="slotModal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Update Test Slot</h3>
        </div>
        <div class="modal-body">
            <form id="slotForm">
                <label for="testCategory">Test Category:</label>
                <select id="testCategory" class="dropdown" required>
                    <option value="" disabled selected>Select Category</option>
                    <option value="Blood Tests">Blood Tests</option>
                    <option value="Prenatal and Pregnancy Tests">Prenatal and Pregnancy Tests</option>
                    <!-- Add other categories -->
                </select>

                <label for="testName">Test Name:</label>
                <input type="text" id="testName" required>

                <label for="testPrice">Price:</label>
                <input type="number" id="testPrice" min="0" required>

                <label for="testDate">Date:</label>
                <input type="date" id="testDate" required>

                <label for="testTime">Time:</label>
                <input type="time" id="testTime" required>

                <label for="slots">Number of Slots:</label>
                <input type="number" id="slots" min="1" required>

                <button type="submit" class="submit-btn">Save</button>
            </form>
        </div>
    </div>
</div>


    
    
        


     <!-- Modal -->
<div id="updateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close" onclick="closeModaldoc()">&times;</span>
            <h2>Update Availability</h2>
        </div>
        <div class="modal-body">
            <label for="date">Choose Date:</label>
            <input type="date" id="date" class="dropdown">
            
            <label for="time-slot">Choose Time Slot:</label>
            <select id="time-slot" class="dropdown">
                <!-- 24-hour time slots -->
                <option value="00:00">00:00</option>
                <option value="01:00">01:00</option>
                <option value="02:00">02:00</option>
                <option value="03:00">03:00</option>
                <option value="04:00">04:00</option>
                <option value="05:00">05:00</option>
                <option value="06:00">06:00</option>
                <option value="07:00">07:00</option>
                <option value="08:00">08:00</option>
                <option value="09:00">09:00</option>
                <option value="10:00">10:00</option>
                <option value="11:00">11:00</option>
                <option value="12:00">12:00</option>
                <option value="13:00">13:00</option>
                <option value="14:00">14:00</option>
                <option value="15:00">15:00</option>
                <option value="16:00">16:00</option>
                <option value="17:00">17:00</option>
                <option value="18:00">18:00</option>
                <option value="19:00">19:00</option>
                <option value="20:00">20:00</option>
                <option value="21:00">21:00</option>
                <option value="22:00">22:00</option>
                <option value="23:00">23:00</option>
            </select>

            <label for="available-slots">Enter Number of Slots:</label>
            <input type="number" id="available-slots" placeholder="Enter number of slots" class="dropdown">
        </div>
        <div class="modal-footer">
            <button class="submit-btn" onclick="updateAvailability()">Submit</button>
        </div>
    </div>
</div>


<div id="inventoryManagement" class="tab-content">
    <h2>Hospital Inventory Management</h2>
    <button class="inv-add-item-btn" onclick="openInvModal()">Add Item</button>

    <h3>Medicines</h3>
    <input type="text" id="medicineSearch" class="search-input" placeholder="Search Medicines" onkeyup="searchTable('medicineTable', this.value)">
    <div class="table-container">
        <table id="medicineTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h3>Equipment</h3>
    <input type="text" id="equipmentSearch" class="search-input" placeholder="Search Equipment" onkeyup="searchTable('equipmentTable', this.value)">
    <div class="table-container">
        <table id="equipmentTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="inv-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeInvModal()">&times;</span>
        <h2 id="modalTitle">Add Item</h2>
        <label for="itemName">Name:</label>
        <input type="text" id="itemName" placeholder="Enter item name">

        <label for="itemCategory">Category:</label>
        <select id="itemCategory">
            <option value="Medicine">Medicine</option>
            <option value="Equipment">Equipment</option>
        </select>

        <label for="itemQuantity">Quantity:</label>
        <input type="number" id="itemQuantity" placeholder="Enter quantity">

        <label for="itemPrice">Price:</label>
        <input type="number" id="itemPrice" placeholder="Enter price">

        <button onclick="saveItem()" class="submit-btn">Save</button>
    </div>
</div>
<div id="patientsManagement" class="tab-content">
    <h2 class="section-title"><i class="fas fa-user-injured"></i> Patient Management</h2>
    <div class="patient-management-container">
        <div class="patient-form-section">
            <h3><i class="fas fa-user-plus"></i> Add New Patient</h3>
            <form id="add-patient-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="patientName"><i class="fas fa-user"></i> Patient Name:</label>
                        <input type="text" id="patientName" name="patientName" placeholder="Enter patient name" required>
                    </div>
                    <div class="form-group">
                        <label for="patientAge"><i class="fas fa-birthday-cake"></i> Age:</label>
                        <input type="number" id="patientAge" name="patientAge" min="0" max="120" placeholder="Enter age" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="patientGender"><i class="fas fa-venus-mars"></i> Gender:</label>
                        <select id="patientGender" name="patientGender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="patientPhone"><i class="fas fa-phone"></i> Phone Number:</label>
                        <input type="tel" id="patientPhone" name="patientPhone" placeholder="Enter phone number" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="patientEmail"><i class="fas fa-envelope"></i> Email:</label>
                        <input type="email" id="patientEmail" name="patientEmail" placeholder="Enter email address">
                    </div>
                    <div class="form-group">
                        <label for="admissionDate"><i class="fas fa-calendar-alt"></i> Admission Date:</label>
                        <input type="date" id="admissionDate" name="admissionDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="bedType"><i class="fas fa-bed"></i> Bed Type:</label>
                        <select id="bedType" name="bedType" required>
                            <option value="">Select Bed Type</option>
                            <!-- Bed options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assignedDoctor"><i class="fas fa-user-md"></i> Assigned Doctor:</label>
                        <select id="assignedDoctor" name="assignedDoctor" required>
                            <option value="">Select Doctor</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="diagnosis"><i class="fas fa-stethoscope"></i> Diagnosis/Reason for Admission:</label>
                    <textarea id="diagnosis" name="diagnosis" rows="3" placeholder="Enter diagnosis or reason for admission" required></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="medicalHistory"><i class="fas fa-notes-medical"></i> Medical History:</label>
                    <textarea id="medicalHistory" name="medicalHistory" rows="3" placeholder="Enter patient's medical history"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="addPatientBtn" class="submit-btn add-btn"><i class="fas fa-plus-circle"></i> Add Patient</button>
                    <button type="reset" class="reset-btn"><i class="fas fa-undo"></i> Reset</button>
                </div>
            </form>
        </div>

        <div class="patient-list-section">
            <h3><i class="fas fa-procedures"></i> Admitted Patients</h3>
            <div class="filter-container">
                <label for="patientSearch"><i class="fas fa-search"></i></label>
                <input type="text" id="patientSearch" class="search-input" placeholder="Search patients..." onkeyup="searchTable('patientsTable', this.value)">
            </div>
            <div class="table-container">
                <table id="patientsTable" class="slots-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-user"></i> Patient Name</th>
                            <th><i class="fas fa-info-circle"></i> Age/Gender</th>
                            <th><i class="fas fa-calendar-alt"></i> Admission Date</th>
                            <th><i class="fas fa-bed"></i> Bed Type</th>
                            <th><i class="fas fa-user-md"></i> Assigned Doctor</th>
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admitted-patients-table">
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="patientsDailyReport" class="tab-content">
    <h2 class="section-title"><i class="fas fa-notes-medical"></i> Patient's Daily Report</h2>
    <div class="patient-management-container">
        <div class="patient-form-section">
            <h3><i class="fas fa-file-medical-alt"></i> Create Daily Health Report</h3>
            <form id="daily-report-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportPatient"><i class="fas fa-user-injured"></i> Select Patient:</label>
                        <select id="reportPatient" name="reportPatient" required>
                            <option value="">Select Patient</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportDate"><i class="fas fa-calendar-day"></i> Report Date:</label>
                        <input type="date" id="reportDate" name="reportDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="bloodPressure"><i class="fas fa-heartbeat"></i> Blood Pressure (mmHg):</label>
                        <input type="text" id="bloodPressure" name="bloodPressure" placeholder="e.g., 120/80" required>
                    </div>
                    <div class="form-group">
                        <label for="heartRate"><i class="fas fa-heart"></i> Heart Rate (bpm):</label>
                        <input type="number" id="heartRate" name="heartRate" min="0" max="250" placeholder="e.g., 72" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="temperature"><i class="fas fa-thermometer-half"></i> Temperature (F):</label>
                        <input type="number" id="temperature" name="temperature" step="0.1" min="95" max="110" placeholder="e.g., 98.6" required>
                    </div>
                    <div class="form-group">
                        <label for="oxygenLevel"><i class="fas fa-lungs"></i> Oxygen Level (%):</label>
                        <input type="number" id="oxygenLevel" name="oxygenLevel" min="0" max="100" placeholder="e.g., 98" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="glucoseLevel"><i class="fas fa-tint"></i> Glucose Level (mg/dL):</label>
                        <input type="number" id="glucoseLevel" name="glucoseLevel" min="0" max="500" placeholder="e.g., 100">
                    </div>
                    <div class="form-group">
                        <label for="painLevel"><i class="fas fa-exclamation-circle"></i> Pain Level (0-10):</label>
                        <input type="number" id="painLevel" name="painLevel" min="0" max="10" placeholder="e.g., 3" required>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="medications"><i class="fas fa-pills"></i> Medications Administered:</label>
                    <textarea id="medications" name="medications" rows="2" placeholder="List medications administered today"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="healthSummary"><i class="fas fa-file-medical"></i> Health Summary:</label>
                    <textarea id="healthSummary" name="healthSummary" rows="3" placeholder="Enter a summary of the patient's health status today" required></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="nurseNotes"><i class="fas fa-clipboard"></i> Nurse's Notes:</label>
                    <textarea id="nurseNotes" name="nurseNotes" rows="2" placeholder="Enter any additional notes or observations"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="submitReportBtn" class="submit-btn add-btn"><i class="fas fa-paper-plane"></i> Submit Report</button>
                    <button type="reset" class="reset-btn"><i class="fas fa-undo"></i> Reset</button>
                </div>
            </form>
        </div>

        <div class="patient-list-section">
            <h3><i class="fas fa-history"></i> Previous Reports</h3>
            <div class="filter-container">
                <label for="reportSearch"><i class="fas fa-search"></i></label>
                <input type="text" id="reportSearch" class="search-input" placeholder="Search reports..." onkeyup="searchTable('reportsTable', this.value)">
            </div>
            <div class="table-container">
                <table id="reportsTable" class="slots-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-user"></i> Patient Name</th>
                            <th><i class="fas fa-calendar-day"></i> Report Date</th>
                            <th><i class="fas fa-heartbeat"></i> Vitals</th>
                            <th><i class="fas fa-file-medical"></i> Summary</th>
                            <th><i class="fas fa-envelope"></i> Notification Status</th>
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patient-reports-table">
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="callManagement" class="tab-content">
    <h2>Call Management</h2>
    <div class="call-management-container">
        <div class="meeting-section">
            <h3>Requests for Video Consultation</h3>
            <table>
                <thead>
                    <tr>
                        <th>Doctor Name</th>
                        <th>Patient Name</th>
                        <th>Specialization</th>
                        <th>Date & Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="video-consultation-requests"></tbody>
            </table>
        </div>

        <div class="meeting-section">
            <h3>Create Meeting Room</h3>
            <button onclick="openCreateRoomForm()">Create Room</button>
            <div id="createRoomForm" class="create-room-form">
                <label>Doctor Name: <input type="text"></label><br>
                <label>Patient Name: <input type="text"></label><br>
                <label>Date & Time: <input type="datetime-local"></label><br>
                <button onclick="openCallModal()">Start Meeting</button>
            </div>
        </div>

        <div class="meeting-section">
            <h3>Ongoing Meeting Rooms</h3>
            <table>
                <thead>
                    <tr>
                        <th>Doctor Name</th>
                        <th>Patient Name</th>
                        <th>Specialization</th>
                        <th>Date & Time</th>
                    </tr>
                </thead>
                <tbody id="ongoing-meeting-rooms"></tbody>
            </table>
        </div>

        <div class="meeting-section">
            <h3>Completed Meeting Rooms</h3>
            <table>
                <thead>
                    <tr>
                        <th>Doctor Name</th>
                        <th>Patient Name</th>
                        <th>Specialization</th>
                        <th>Date & Time</th>
                    </tr>
                </thead>
                <tbody id="completed-meeting-rooms"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="callModal" class="call-modal">
    <iframe src="https://auramed-vc.onrender.com/"></iframe>
    <button onclick="closeCallModal()">Close</button>
</div>

    <script>


        function openSection(sectionName) {
            // Hide all section tabs
            const sectionTabs = document.getElementsByClassName('section-tabs');
            for (let tabs of sectionTabs) {
                tabs.classList.remove('active');
            }
            
            // Show the selected section tabs
            document.getElementById(sectionName + 'Tabs').classList.add('active');
            
            // Update section buttons
            const sectionBtns = document.getElementsByClassName('section-btn');
            for (let btn of sectionBtns) {
                btn.classList.remove('active');
            }
            document.querySelector(`[onclick="openSection('${sectionName}')"]`).classList.add('active');
            
            // Open the first tab in the section
            const firstTabBtn = document.querySelector(`#${sectionName}Tabs .tab`);
            if (firstTabBtn) {
                const firstTabId = firstTabBtn.getAttribute('onclick').match(/'([^']+)'/)[1];
                openTab(firstTabId);
            }
        }
        
        function openTab(tabName) {
            // Hide all tab content
            let tabs = document.getElementsByClassName("tab-content");
            for (let tab of tabs) { tab.classList.remove("active"); }
            document.getElementById(tabName).classList.add("active");
            
            // Update tab buttons
            let tabButtons = document.getElementsByClassName("tab");
            for (let button of tabButtons) { button.classList.remove("active"); }
            document.querySelector(`[onclick="openTab('${tabName}')"]`).classList.add("active");
        }
        



        function makeEditable() {
            const phone = document.getElementById('phone');
            const address = document.getElementById('address');
            const email = document.getElementById('email');

            if (phone.isContentEditable) {
                phone.contentEditable = "false";
                address.contentEditable = "false";
                email.contentEditable = "false";
            } else {
                phone.contentEditable = "true";
                address.contentEditable = "true";
                email.contentEditable = "true";
                phone.focus();
            }
        }

        async function fetchHospitalDetails() {
            try {
                const response = await fetch('/get-hospital-details');
                const result = await response.json();
    
                // Handle both response formats (direct data or {success, data})
                const data = result.success ? result.data : result;
    
                // Check if elements exist before setting their content
                const hospitalName = document.getElementById('hospital-name');
                const phone = document.getElementById('phone');
                const address = document.getElementById('address');
                const email = document.getElementById('email');
                const profilePicture = document.getElementById('profile-picture');
                
                if (hospitalName) hospitalName.textContent = data.name || "Hospital Name";
                if (phone) phone.textContent = data.phone || "N/A";
                if (address) address.textContent = data.address || "N/A";
                if (email) email.textContent = data.email || "N/A";
    
                if (profilePicture && data.profile_picture) {
                    profilePicture.src = data.profile_picture;
                    profilePicture.style.display = "block";
                }
            } catch (error) {
                console.error("Error fetching hospital details:", error);
            }
        }
    
        // Call the functions on page load
        // Define fetchHospitalDetailsForDashboard function before it's used
        async function fetchHospitalDetailsForDashboard() {
            await fetchHospitalDetails();
            // Fetch OPD prediction data
            fetchOPDPrediction();
        }
        
        // Update dashboard metrics
        function updateDashboardMetrics() {
            // Fetch real-time metrics from the backend API
            fetch('/api/dashboard-metrics')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch dashboard metrics');
                    }
                    return response.json();
                })
                .then(data => {
                    // Update OPD Patients metric
                    const opdPatientsElement = document.querySelector('.metric-card:nth-child(1) .metric-value');
                    const opdTrendElement = document.querySelector('.metric-card:nth-child(1) .metric-trend');
                    if (opdPatientsElement && opdTrendElement && data.opd_patients) {
                        opdPatientsElement.textContent = data.opd_patients.count;
                        opdTrendElement.textContent = data.opd_patients.trend_text;
                        opdTrendElement.className = 'metric-trend ' + 
                            (data.opd_patients.trend > 0 ? 'positive' : data.opd_patients.trend < 0 ? 'negative' : 'neutral');
                    }
                    
                    // Update Available Beds metric
                    const bedsElement = document.querySelector('.metric-card:nth-child(2) .metric-value');
                    const bedsTrendElement = document.querySelector('.metric-card:nth-child(2) .metric-trend');
                    if (bedsElement && bedsTrendElement && data.available_beds) {
                        bedsElement.textContent = data.available_beds.count;
                        bedsTrendElement.textContent = data.available_beds.trend_text;
                        bedsTrendElement.className = 'metric-trend ' + 
                            (data.available_beds.trend > 0 ? 'positive' : data.available_beds.trend < 0 ? 'negative' : 'neutral');
                    }
                    
                    // Update Inventory Items metric
                    const inventoryElement = document.querySelector('.metric-card:nth-child(3) .metric-value');
                    const inventoryTrendElement = document.querySelector('.metric-card:nth-child(3) .metric-trend');
                    if (inventoryElement && inventoryTrendElement && data.inventory_items) {
                        inventoryElement.textContent = data.inventory_items.count;
                        inventoryTrendElement.textContent = data.inventory_items.trend_text;
                        inventoryTrendElement.className = 'metric-trend ' + 
                            (data.inventory_items.trend > 0 ? 'positive' : data.inventory_items.trend < 0 ? 'negative' : 'neutral');
                    }
                    
                    // Update Current Admissions metric
                    const admissionsElement = document.querySelector('.metric-card:nth-child(4) .metric-value');
                    const admissionsTrendElement = document.querySelector('.metric-card:nth-child(4) .metric-trend');
                    if (admissionsElement && admissionsTrendElement && data.current_admissions) {
                        admissionsElement.textContent = data.current_admissions.count;
                        admissionsTrendElement.textContent = data.current_admissions.trend_text;
                        admissionsTrendElement.className = 'metric-trend ' + 
                            (data.current_admissions.trend > 0 ? 'positive' : data.current_admissions.trend < 0 ? 'negative' : 'neutral');
                    }
                    
                    // Update Tests metric
                    const testsElement = document.querySelector('.metric-card:nth-child(5) .metric-value');
                    const testsTrendElement = document.querySelector('.metric-card:nth-child(5) .metric-trend');
                    if (testsElement && testsTrendElement && data.tests) {
                        testsElement.textContent = data.tests.count;
                        testsTrendElement.textContent = data.tests.trend_text;
                        testsTrendElement.className = 'metric-trend ' + 
                            (data.tests.trend > 0 ? 'positive' : data.tests.trend < 0 ? 'negative' : 'neutral');
                    }
                })
                .catch(error => {
                    console.error('Failed to update dashboard metrics:', error);
                });
        }
        
        window.onload = function() {
            fetchHospitalDetails();
            fetchHospitalDetailsForDashboard();
            updateDashboardMetrics();
        };


        function makeEditable() {
            document.getElementById('hospital-name').contentEditable = true;
            document.getElementById('phone').contentEditable = true;
            document.getElementById('address').contentEditable = true;
            document.getElementById('hospital-name').focus();
    
            // Check if save button already exists
            if (!document.getElementById('dashboard-save-btn')) {
                const saveButton = document.createElement('button');
                saveButton.id = 'dashboard-save-btn';
                saveButton.className = 'edit-btn';
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save';
                saveButton.onclick = saveDashboardDetails;
                document.querySelector('.hospital-info').appendChild(saveButton);
            }
        }
        
        async function saveDashboardDetails() {
            const name = document.getElementById('hospital-name').textContent.trim();
            const phone = document.getElementById('phone').textContent.trim();
            const address = document.getElementById('address').textContent.trim();
    
            if (!name || !phone || !address) {
                alert("All fields are required!");
                return;
            }
    
            const formData = new FormData();
            formData.append('name', name);
            formData.append('phone', phone);
            formData.append('address', address);
    
            try {
                const response = await fetch('/update-hospital-details', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
    
                if (result.success) {
                    alert(result.message);
                    // Make fields non-editable again
                    document.getElementById('hospital-name').contentEditable = false;
                    document.getElementById('phone').contentEditable = false;
                    document.getElementById('address').contentEditable = false;
                    
                    // Remove the save button
                    const saveButton = document.getElementById('dashboard-save-btn');
                    if (saveButton) {
                        saveButton.remove();
                    }
                    
                    // Refresh the dashboard data
                    fetchHospitalDetailsForDashboard();
                    updateDashboardMetrics();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error("Error updating hospital details:", error);
                alert("An error occurred while updating hospital details.");
            }
        }
    
        async function saveHospitalDetails() {
            const name = document.getElementById('hospital-name').textContent.trim();
            const phone = document.getElementById('phone').textContent.trim();
            const address = document.getElementById('address').textContent.trim();
    
            if (!name || !phone || !address) {
                alert("All fields are required!");
                return;
            }
    
            const formData = new FormData();
            formData.append('name', name);
            formData.append('phone', phone);
            formData.append('address', address);
    
            // Optionally, include profile picture if edited
            const profilePictureInput = document.getElementById('profile-picture-input');
            if (profilePictureInput && profilePictureInput.files[0]) {
                formData.append('profile_picture', profilePictureInput.files[0]);
            }
    
            try {
                const response = await fetch('/update-hospital-details', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
    
                if (result.success) {
                    alert(result.message);
                    location.reload(); // Reload to fetch updated data
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error("Error updating hospital details:", error);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            fetch('/get-doctors')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const doctorsTable = document.getElementById('doctors-table');
                        doctorsTable.innerHTML = ''; // Clear existing rows
        
                        data.data.forEach(doctor => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${doctor.name}</td>
                                <td>${doctor.specialization}</td>
                                <td>${Object.keys(doctor.availability).map(date => `
                                    <div>
                                        <strong>${date}:</strong>
                                        ${Object.entries(doctor.availability[date]).map(
                                            ([time, slots]) => `${time} (${slots} slots)`
                                        ).join(', ')}
                                    </div>
                                `).join('')}</td>
                                <td>
                                    <button class="action-btn" onclick="showUpdateModal('${doctor.name}')">Update</button>
                                </td>
                            `;
                            doctorsTable.appendChild(row);
                        });
                    } else {
                        alert(data.message);
                    }
                });
        });
        
        let currentDoctor = "";
        
        // Open the modal and set the doctor name
function showUpdateModal(doctorName) {
    currentDoctor = doctorName;
    document.getElementById('updateModal').style.display = 'block';
}

function closeModaldoc() {
    console.log('Close button clicked');
    document.getElementById('updateModal').style.display = 'none';
}

        
        // Update availability and submit the data
function updateAvailability() {
    const date = document.getElementById('date').value;
    const timeSlot = document.getElementById('time-slot').value;
    const availableSlots = document.getElementById('available-slots').value;

    if (!date || !timeSlot || !availableSlots) {
        alert("Please fill out all fields.");
        return;
    }

    fetch('/update-doctor-availability', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: currentDoctor,
            availability: {
                [date]: {
                    [timeSlot]: parseInt(availableSlots)
                }
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Availability updated successfully!");
            location.reload(); // Refresh to show updated data
        } else {
            alert(data.message);
        }
    });

    closeModal();
}

// Close modal on outside click
window.onclick = function(event) {
    const modal = document.getElementById('updateModal');
    if (event.target === modal) {
        closeModal();
    }
};



document.addEventListener('DOMContentLoaded', () => {
    // Handle Appointments
    const ongoingAppointmentsTable = document.getElementById('ongoing-appointments-table');
    const completedAppointmentsTable = document.getElementById('completed-appointments-table');

    // Fetch and populate appointments table
fetch('/get_appointments')
.then(response => response.json())
.then(data => {
    ongoingAppointmentsTable.innerHTML = '';
    completedAppointmentsTable.innerHTML = '';

    // Sort appointments by `created_at` timestamp
    data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

    data.forEach(appointment => {
        const ongoingRow = `
            <tr>
                <td>${appointment.patient_name}</td>
                <td>${appointment.doctor_name}</td>
                <td>${appointment.doctor_specialization}</td>
                <td>${appointment.status}</td>
                <td>
                    <button class="action-btn done-btn" data-id="${appointment.appointment_id}">Done</button>
                    <button class="action-btn upload-btn" data-id="${appointment.appointment_id}">Upload Prescription</button>
                </td>
            </tr>`;

        const completedRow = `
            <tr>
                <td>${appointment.patient_name}</td>
                <td>${appointment.doctor_name}</td>
                <td>${appointment.doctor_specialization}</td>
                <td>${appointment.status}</td>
            </tr>`;

        if (appointment.status === 'completed') {
            completedAppointmentsTable.insertAdjacentHTML('beforeend', completedRow);
        } else {
            ongoingAppointmentsTable.insertAdjacentHTML('beforeend', ongoingRow);
        }
    });
})
.catch(err => console.error('Failed to fetch appointments:', err));

ongoingAppointmentsTable.addEventListener('click', handleAppointmentActions);

const ongoingTestsTable = document.getElementById('ongoing-tests-table');
const completedTestsTable = document.getElementById('completed-tests-table');


// Fetch and populate tests table
fetch('/get_tests')
    .then(response => response.json())
    .then(data => {
        // Sort tests by booking_timestamp (earliest first)
        data.sort((a, b) => new Date(a.booking_timestamp) - new Date(b.booking_timestamp));
        
        ongoingTestsTable.innerHTML = '';
        completedTestsTable.innerHTML = '';
        data.forEach(test => {
            const ongoingRow = `
                <tr>
                    <td>${test.patient_name}</td>
                    <td>${test.hospital_name}</td>
                    <td>${test.test_type}</td>
                    <td>${test.test_slot_code}</td>
                    <td>${test.status}</td>
                    <td>
                        <button class="action-btn done-btn" data-id="${test.test_slot_code}">Done</button>
                        <button class="action-btn upload-btn" data-id="${test.test_slot_code}">Upload Report</button>
                    </td>
                </tr>`;

            const completedRow = `
                <tr>
                    <td>${test.patient_name}</td>
                    <td>${test.hospital_name}</td>
                    <td>${test.test_type}</td>
                    <td>${test.test_slot_code}</td>
                    <td>${test.status}</td>
                </tr>`;

            if (test.status === 'completed') {
                completedTestsTable.insertAdjacentHTML('beforeend', completedRow);
            } else {
                ongoingTestsTable.insertAdjacentHTML('beforeend', ongoingRow);
            }
        });
    })
    .catch(err => console.error('Failed to fetch tests:', err));

ongoingTestsTable.addEventListener('click', handleTestActions);

    // Handle Appointment Actions
    function handleAppointmentActions(e) {
        if (e.target.classList.contains('done-btn')) {
            const appointmentId = e.target.getAttribute('data-id');
            fetch('/update_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ appointment_id: appointmentId, status: 'completed' }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Appointment marked as completed!');
                        location.reload();
                    }
                })
                .catch(err => console.error('Error marking appointment as completed:', err));
        }

        if (e.target.classList.contains('upload-btn')) {
            const appointmentId = e.target.getAttribute('data-id');
            const formData = new FormData();
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf';
            fileInput.onchange = () => {
                formData.append('appointment_id', appointmentId);
                formData.append('prescription', fileInput.files[0]);
                fetch('/upload_prescription', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Prescription uploaded successfully!');
                            location.reload();
                        }
                    })
                    .catch(err => console.error('Error uploading prescription:', err))
                    .finally(() => fileInput.remove());
            };
            fileInput.click();
        }
    }

    // Handle Test Actions
    function handleTestActions(e) {
        const target = e.target;
        const testSlotCode = target.dataset.id;

        if (target.classList.contains('done-btn')) {
            fetch('/update_status_test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ test_slot_code: testSlotCode }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) { // Check for 'message' in the response
                    alert('Test marked as completed!');
                    location.reload();
                } else {
                    console.error('Error:', data.error);
                }
            })
            .catch(err => console.error('Error updating test status:', err));
        }
        

        if (target.classList.contains('upload-btn')) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.jpg,.png,.docx';

            fileInput.onchange = () => {
                const file = fileInput.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('test_slot_code', testSlotCode);
                formData.append('file', file);

                fetch('/upload_report', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => alert(data.message))
                    .catch(err => console.error('Error uploading report:', err))
                    .finally(() => fileInput.remove());
            };

            fileInput.click();
        }
    }
});

 



        
        // Fetch bed availability data and populate the table
    fetch('/bed_availability')
    .then(response => response.json())
    .then(data => {
        const tableBody = document.getElementById('bed-availability-table');
        if (!tableBody) {
            console.error('Could not find bed-availability-table element');
            return;
        }
        tableBody.innerHTML = '';

        data.forEach(bed => {
            const row = document.createElement('tr');

            row.innerHTML = `
                <td>${bed.type}</td>
                <td>${bed.available}</td>
                <td><button class="action-btn" onclick="updateBed('${bed.type}')">Update</button></td>
            `;

            tableBody.appendChild(row);
        });
    });

function updateBed(bedType) {
    const newAvailability = prompt(`Enter new availability for ${bedType}:`);
    if (newAvailability !== null) {
        fetch('/update_bed', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ type: bedType, available: parseInt(newAvailability) })
        }).then(response => {
            if (response.ok) {
                alert('Bed availability updated!');
                location.reload();
            } else {
                alert('Failed to update bed availability.');
            }
        });
    }
}
let availability = {};

    function openAddDoctorModal() {
        document.getElementById('add-doctor-modal').style.display = 'block';
    }

    function closeAddDoctorModal() {
        document.getElementById('add-doctor-modal').style.display = 'none';
    }

    function addAvailability() {
        const date = document.getElementById('availability-date').value;
        const time = document.getElementById('availability-time').value;

        if (!date || !time) {
            alert('Please select both a date and a time.');
            return;
        }

        if (!availability[date]) {
            availability[date] = [];
        }
        availability[date].push(time);

        updateAvailabilityList();
    }

    function updateAvailabilityList() {
        const list = document.getElementById('availability-list');
        list.innerHTML = '';
        for (const [date, times] of Object.entries(availability)) {
            const listItem = document.createElement('li');
            listItem.textContent = `${date}: ${times.join(', ')}`;
            list.appendChild(listItem);
        }
    }

    async function addDoctor() {
        const form = document.getElementById('add-doctor-form');
        const formData = new FormData(form);
        const doctorData = {};

        formData.forEach((value, key) => {
            if (key === 'degrees' || key === 'achievements') {
                doctorData[key] = value.split(',').map((item) => item.trim());
            } else if (key === 'experience') {
                doctorData[key] = value;
            } else {
                doctorData[key] = value;
            }
        });

        doctorData.availability = availability;

        const response = await fetch('/add-doctor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(doctorData),
        });

        if (response.ok) {
            alert('Doctor added successfully!');
            closeAddDoctorModal();
            form.reset();
            availability = {};
            updateAvailabilityList();
        } else {
            alert('Failed to add doctor.');
        }
    }


    document.addEventListener("DOMContentLoaded", () => {
        const testAvailabilityTable = document.getElementById("test-availability-table");
        const slotModal = document.getElementById("slotModal");
        const slotForm = document.getElementById("slotForm");
        const testCategoryFilter = document.getElementById("testCategoryFilter");
    
        // Function to fetch and display test slots
        async function fetchTestSlots(filter = "") {
            const response = await fetch('/get_test_slots');
            const data = await response.json();
            testAvailabilityTable.innerHTML = "";
    
            for (const [category, tests] of Object.entries(data)) {
                if (filter && category !== filter) continue;
    
                for (const [testName, details] of Object.entries(tests)) {
                    const { price, ...dates } = details;
    
                    for (const [date, times] of Object.entries(dates)) {
                        for (const [time, slotDetails] of Object.entries(times)) {
                            const { slots } = slotDetails;
    
                            const row = `
                                <tr>
                                    <td>${category}</td>
                                    <td>${testName}</td>
                                    <td>${price}</td>
                                    <td>${date}</td>
                                    <td>${time} (${slots} slots)</td>
                                    <td>
                                        <button class="action-btn" onclick="editSlot('${category}', '${testName}', ${price}, '${date}', '${time}', ${slots})">Edit</button>
                                    </td>
                                </tr>
                            `;
                            testAvailabilityTable.innerHTML += row;
                        }
                    }
                }
            }
        }
    
        function openModal() {
            slotModal.style.display = "block";
        }
    
        function closeModal() {
            slotModal.style.display = "none";
        }
    
        function editSlot(category, testName, price, date, time, slots) {
            document.getElementById("testCategory").value = category;
            document.getElementById("testName").value = testName;
            document.getElementById("testPrice").value = price;
            document.getElementById("testDate").value = date;
            document.getElementById("testTime").value = time;
            document.getElementById("slots").value = slots;
            openModal();
        }
    
        slotForm.addEventListener("submit", async (event) => {
            event.preventDefault();
    
            const category = document.getElementById("testCategory").value;
            const testName = document.getElementById("testName").value;
            const price = document.getElementById("testPrice").value;
            const date = document.getElementById("testDate").value;
            const time = document.getElementById("testTime").value;
            const slots = document.getElementById("slots").value;
    
            const response = await fetch('/update_test_slot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category, testName, price, date, time, slots }),
            });
    
            if (response.ok) {
                alert("Slot updated successfully!");
                fetchTestSlots(testCategoryFilter.value);
                closeModal();
            } else {
                alert("Error updating slot.");
            }
        });
    
        testCategoryFilter.addEventListener("change", () => {
            fetchTestSlots(testCategoryFilter.value);
        });
    
        fetchTestSlots();
    
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.editSlot = editSlot;
    });


    let inventory = [];
let editIndex = null;

// Fetch inventory data from Flask backend
async function fetchInventory() {
    try {
        const response = await fetch("/inventory/get_inventory");
        console.log("Response status:", response.status);
        console.log("Raw response:", response);

        if (!response.ok) {
            const errorData = await response.json();
            console.error("Error fetching inventory:", errorData.error || errorData.message);
            return;
        }

        const data = await response.json(); // Parse JSON
        console.log("Parsed data:", data);

        // Reset and populate inventory
        inventory = [];
        processInventoryResponse(data);

        console.log("Inventory after fetch:", inventory);
        renderTable(); // Render the table with updated inventory
    } catch (error) {
        console.error("Network error:", error);
    }
}

// Process the API response and populate inventory
function processInventoryResponse(data) {
    if (Array.isArray(data)) {
        data.forEach(item => {
            inventory.push({
                id: generateUniqueId(),
                name: item.name,
                category: item.category,
                quantity: item.quantity,
                price: item.price || "N/A" // Default price if missing
            });
        });
    } else {
        console.warn("Unexpected response format:", data);
    }
}

// Render the inventory table
function renderTable() {
    const tables = {
        Medicine: document.querySelector("#medicineTable tbody"),
        Equipment: document.querySelector("#equipmentTable tbody")
    };

    // Clear existing table rows
    Object.values(tables).forEach(tbody => (tbody.innerHTML = ""));

    inventory.forEach((item, index) => {
        const tableId = item.category;
        const tbody = tables[tableId];

        if (!tbody) {
            console.warn(`No table found for category: ${tableId}`);
            return;
        }

        // Create a new row
        const row = document.createElement("tr");
        row.id = item.id;

        row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.price}</td>
            <td>
                <button class="inv-edit-btn" onclick="openInvModal(${index})">Edit</button>
                <button class="inv-delete-btn" onclick="deleteItem(${index})">Delete</button>
            </td>
        `;

        console.log(`Appending row to ${tableId} table:`, row);
        tbody.appendChild(row);
    });

    // Log final table content for debugging
    console.log("Medicine Table HTML:", tables.Medicine.innerHTML);
    console.log("Equipment Table HTML:", tables.Equipment.innerHTML);
}


// Open modal for adding or editing items
function openInvModal(index = null) {
    document.getElementById("inv-modal").style.display = "block";
    document.getElementById("modalTitle").innerText = index === null ? "Add Item" : "Edit Item";

    if (index !== null) {
        editIndex = index;
        const item = inventory[index];
        document.getElementById("itemName").value = item.name;
        document.getElementById("itemCategory").value = item.category;
        document.getElementById("itemQuantity").value = item.quantity;
        document.getElementById("itemPrice").value = item.price;
    } else {
        editIndex = null;
        document.getElementById("itemName").value = "";
        document.getElementById("itemCategory").value = "Medicine";
        document.getElementById("itemQuantity").value = "";
        document.getElementById("itemPrice").value = "";
    }
}

function closeInvModal() {
    document.getElementById("inv-modal").style.display = "none";
}

// Generate unique ID for items
function generateUniqueId() {
    return 'item-' + new Date().getTime() + '-' + Math.floor(Math.random() * 1000);
}

// Save a new or edited item
async function saveItem() {
    const name = document.getElementById("itemName").value;
    const category = document.getElementById("itemCategory").value;
    const quantity = parseInt(document.getElementById("itemQuantity").value, 10);
    const price = document.getElementById("itemPrice").value;

    if (editIndex !== null) {
        inventory[editIndex] = { id: inventory[editIndex].id, name, category, quantity, price };
    } else {
        inventory.push({ id: generateUniqueId(), name, category, quantity, price });
    }

    await updateBackendInventory();
    closeInvModal();
    renderTable();
}

// Delete an item from the inventory
async function deleteItem(index) {
    inventory.splice(index, 1);
    await updateBackendInventory();
    renderTable();
}

// Update inventory data in the backend
async function updateBackendInventory() {
    try {
        const response = await fetch("/inventory/update_inventory", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ inventory })
        });

        const result = await response.json();

        if (!response.ok) {
            console.error("Error updating inventory:", result.error || result.message);
        }
    } catch (error) {
        console.error("Network error while updating inventory:", error);
    }
}
// Search table rows based on input
function searchTable(tableId, query) {
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName("tr");
    const lowerQuery = query.toLowerCase();

    for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let match = false;

        for (let j = 0; j < cells.length; j++) {
            if (cells[j].textContent.toLowerCase().includes(lowerQuery)) {
                match = true;
                break;
            }
        }

        rows[i].style.display = match ? "" : "none";
    }
}

// Add confirmation before deleting an item
async function deleteItem(index) {
    const confirmDelete = confirm("Are you sure you want to delete this item?");
    if (!confirmDelete) return;

    inventory.splice(index, 1);
    await updateBackendInventory();
    renderTable();
}
// Fetch and render inventory when the page loads
fetchInventory();

function openCreateRoomForm() {
    document.getElementById("createRoomForm").style.display = "block";
}
function openCallModal() {
    document.getElementById("callModal").style.display = "block";
}
function closeCallModal() {
    document.getElementById("callModal").style.display = "none";
}
document.addEventListener("DOMContentLoaded", () => {
    console.log("Document loaded. Fetching video calls...");

    fetch("/get_video_calls")
        .then((response) => {
            console.log("Response received from /get_video_calls:", response);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then((data) => {
            console.log("Data received from server:", data);
            if (data.success) {
                console.log("Populating video consultation requests...");
                populateTable("video-consultation-requests", data.requests, true);

                console.log("Populating ongoing meeting rooms...");
                populateTable("ongoing-meeting-rooms", data.ongoing, false);

                console.log("Populating completed meeting rooms...");
                populateTable("completed-meeting-rooms", data.completed, false);
            } else {
                console.error("Server returned success: false. Data:", data);
            }
        })
        .catch((error) => console.error("Error fetching video calls:", error));
});

function populateTable(tableId, items, includeActions) {
    console.log(`Populating table: ${tableId} with ${items.length} items`);
    const table = document.getElementById(tableId);

    if (!table) {
        console.error(`Table with ID ${tableId} not found.`);
        return;
    }

    table.innerHTML = ""; // Clear existing rows

    items.forEach((item, index) => {
        console.log(`Adding row ${index + 1} to table ${tableId}:`, item);
        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${item.doctor_name}</td>
            <td>${item.patient_name}</td>
            <td>${item.specialization}</td>
            <td>${item.datetime || "N/A"}</td>
            ${
                includeActions
                    ? `<td>
                        <button class="approve-btn">Approve</button>
                        <button class="decline-btn">Decline</button>
                    </td>`
                    : "<td></td>"
            }
        `;

        table.appendChild(row);
    });

    console.log(`Finished populating table: ${tableId}`);
}

// Patient Management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize patient management functionality if we're on that tab
    if (document.getElementById('patientsManagement')) {
        initializePatientManagement();
    }
});

function initializePatientManagement() {
    // Fetch doctors for the dropdown
    fetchDoctorsForDropdown();
    
    // Fetch existing patients
    fetchAdmittedPatients();
    
    // Add event listener to the Add Patient button
    document.getElementById('addPatientBtn').addEventListener('click', addPatient);
}

async function fetchDoctorsForDropdown() {
    try {
        const response = await fetch('/get-doctors');
        if (!response.ok) {
            throw new Error('Failed to fetch doctors');
        }
        
        const data = await response.json();
        const doctorSelect = document.getElementById('assignedDoctor');
        
        // Clear existing options except the first one
        while (doctorSelect.options.length > 1) {
            doctorSelect.remove(1);
        }
        
        // Check if the response has the expected structure
        if (data.success && Array.isArray(data.data)) {
            // Add doctors to dropdown
            data.data.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.name; // Using name as value since email isn't in the response
                option.textContent = `Dr. ${doctor.name} (${doctor.specialization})`;
                doctorSelect.appendChild(option);
            });
            console.log('Doctors loaded successfully:', data.data.length);
        } else {
            console.error('Unexpected response format:', data);
        }
    } catch (error) {
        console.error('Error fetching doctors:', error);
    }
}

async function fetchAdmittedPatients() {
    try {
        const response = await fetch('/get-admitted-patients');
        if (!response.ok) {
            throw new Error('Failed to fetch admitted patients');
        }
        
        const data = await response.json();
        renderPatientTable(data);
    } catch (error) {
        console.error('Error fetching admitted patients:', error);
    }
}

function renderPatientTable(patients) {
    const tableBody = document.getElementById('admitted-patients-table');
    tableBody.innerHTML = '';
    
    if (patients.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" class="no-data">No patients currently admitted</td>';
        tableBody.appendChild(row);
        return;
    }
    
    patients.forEach(patient => {
        const row = document.createElement('tr');
        
        // Format the bed information
        let bedInfo = patient.bed_type;
        if (patient.floor && patient.bed_id) {
            bedInfo = `${patient.bed_type} - Floor ${patient.floor} Bed ${patient.bed_id}`;
        }
        
        row.innerHTML = `
            <td>${patient.name}</td>
            <td>${patient.age} / ${patient.gender}</td>
            <td>${formatDate(patient.admission_date)}</td>
            <td>${bedInfo}</td>
            <td>${patient.assigned_doctor}</td>
            <td>
                <button class="action-btn" onclick="viewPatientDetails('${patient._id}')">View</button>
                <button class="action-btn" onclick="dischargePatient('${patient._id}')">Discharge</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

async function addPatient() {
    const form = document.getElementById('add-patient-form');
    
    // Basic form validation
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Get the bed information from the dropdown
    const bedTypeValue = document.getElementById('bedType').value;
    let bedInfo = {};
    
    // Parse the JSON bed information
    try {
        if (bedTypeValue) {
            bedInfo = JSON.parse(bedTypeValue);
        }
    } catch (error) {
        console.error('Error parsing bed information:', error);
        // If parsing fails, use the original value
        bedInfo = {
            bed_type: bedTypeValue
        };
    }
    
    // Collect form data
    const patientData = {
        name: document.getElementById('patientName').value,
        age: document.getElementById('patientAge').value,
        gender: document.getElementById('patientGender').value,
        phone: document.getElementById('patientPhone').value,
        email: document.getElementById('patientEmail').value,
        admission_date: document.getElementById('admissionDate').value,
        assigned_doctor: document.getElementById('assignedDoctor').value,
        diagnosis: document.getElementById('diagnosis').value,
        medical_history: document.getElementById('medicalHistory').value,
        // Add the bed information in the correct format
        bed_type: bedInfo.bed_type || '',
        floor: bedInfo.floor || '',
        bed_id: bedInfo.bed_id || ''
    };
    
    try {
        const response = await fetch('/admit-patient', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(patientData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to admit patient');
        }
        
        const result = await response.json();
        alert('Patient admitted successfully!');
        
        // Reset form and refresh patient list
        form.reset();
        fetchAdmittedPatients();
        
        // Refresh the bed type dropdown to show updated availability
        populateBedTypeDropdown();
        
        // Refresh bed data display
        fetchBedData();
    } catch (error) {
        console.error('Error admitting patient:', error);
        alert(`Error: ${error.message}`);
    }
}

async function viewPatientDetails(patientId) {
    try {
        const response = await fetch(`/get-patient/${patientId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch patient details');
        }
        
        const patient = await response.json();
        
        // Format the bed information
        let bedInfo = patient.bed_type;
        if (patient.floor && patient.bed_id) {
            bedInfo = `${patient.bed_type} - Floor ${patient.floor} Bed ${patient.bed_id}`;
        }
        
        alert(`Patient Details:\n\nName: ${patient.name}\nAge: ${patient.age}\nGender: ${patient.gender}\nPhone: ${patient.phone}\nEmail: ${patient.email}\nAdmission Date: ${formatDate(patient.admission_date)}\nBed: ${bedInfo}\nAssigned Doctor: ${patient.assigned_doctor}\nDiagnosis: ${patient.diagnosis}\nMedical History: ${patient.medical_history}`);
        
        // In a real application, you would show this in a modal instead of an alert
    } catch (error) {
        console.error('Error fetching patient details:', error);
        alert(`Error: ${error.message}`);
    }
}

async function dischargePatient(patientId) {
    if (!confirm('Are you sure you want to discharge this patient?')) {
        return;
    }
    
    try {
        const response = await fetch(`/discharge-patient/${patientId}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to discharge patient');
        }
        
        alert('Patient discharged successfully!');
        fetchAdmittedPatients();
        
        // Refresh the bed type dropdown to show updated availability
        populateBedTypeDropdown();
        
        // Refresh bed data display
        fetchBedData();
    } catch (error) {
        console.error('Error discharging patient:', error);
        alert(`Error: ${error.message}`);
    }
}

// Patient's Daily Report JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize patient daily report functionality if we're on that tab
    if (document.getElementById('patientsDailyReport')) {
        initializePatientDailyReport();
    }
});

function initializePatientDailyReport() {
    // Set default date to today
    document.getElementById('reportDate').valueAsDate = new Date();
    
    // Fetch admitted patients for the dropdown
    fetchPatientsForReportDropdown();
    
    // Fetch existing reports
    fetchPatientReports();
    
    // Add event listener to the Submit Report button
    document.getElementById('submitReportBtn').addEventListener('click', submitDailyReport);
}

async function fetchPatientsForReportDropdown() {
    try {
        const response = await fetch('/get-admitted-patients');
        if (!response.ok) {
            throw new Error('Failed to fetch admitted patients');
        }
        
        const patients = await response.json();
        const patientSelect = document.getElementById('reportPatient');
        
        // Clear existing options except the first one
        while (patientSelect.options.length > 1) {
            patientSelect.remove(1);
        }
        
        // Add patients to dropdown
        patients.forEach(patient => {
            const option = document.createElement('option');
            option.value = patient._id;
            option.textContent = `${patient.name} (${patient.age}/${patient.gender})`;
            patientSelect.appendChild(option);
        });
        
        console.log('Patients loaded for report dropdown:', patients.length);
    } catch (error) {
        console.error('Error fetching patients for report:', error);
    }
}

async function submitDailyReport() {
    const form = document.getElementById('daily-report-form');
    
    // Basic form validation
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Collect form data
    const reportData = {
        patient_id: document.getElementById('reportPatient').value,
        report_date: document.getElementById('reportDate').value,
        vitals: {
            blood_pressure: document.getElementById('bloodPressure').value,
            heart_rate: document.getElementById('heartRate').value,
            temperature: document.getElementById('temperature').value,
            oxygen_level: document.getElementById('oxygenLevel').value,
            glucose_level: document.getElementById('glucoseLevel').value || 'Not measured',
            pain_level: document.getElementById('painLevel').value
        },
        medications: document.getElementById('medications').value,
        health_summary: document.getElementById('healthSummary').value,
        nurse_notes: document.getElementById('nurseNotes').value
    };
    
    try {
        const response = await fetch('/submit-patient-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(reportData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to submit report');
        }
        
        const result = await response.json();
        alert('Patient report submitted successfully!');
        
        // Reset form and refresh reports
        form.reset();
        document.getElementById('reportDate').valueAsDate = new Date();
        fetchPatientReports();
    } catch (error) {
        console.error('Error submitting patient report:', error);
        alert(`Error: ${error.message}`);
    }
}

async function fetchPatientReports() {
    try {
        const response = await fetch('/get-patient-reports');
        if (!response.ok) {
            throw new Error('Failed to fetch patient reports');
        }
        
        const reports = await response.json();
        renderReportsTable(reports);
    } catch (error) {
        console.error('Error fetching patient reports:', error);
    }
}

function renderReportsTable(reports) {
    const tableBody = document.getElementById('patient-reports-table');
    tableBody.innerHTML = '';
    
    if (reports.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" class="no-data">No reports available</td>';
        tableBody.appendChild(row);
        return;
    }
    
    reports.forEach(report => {
        const row = document.createElement('tr');
        
        // Format vitals for display
        const vitals = `BP: ${report.vitals.blood_pressure}, HR: ${report.vitals.heart_rate}, Temp: ${report.vitals.temperature}F, O: ${report.vitals.oxygen_level}%`;
        
        // Truncate summary for display
        const summary = report.health_summary.length > 50 ? 
            report.health_summary.substring(0, 50) + '...' : 
            report.health_summary;
        
        row.innerHTML = `
            <td>${report.patient_name}</td>
            <td>${formatDate(report.report_date)}</td>
            <td>${vitals}</td>
            <td>${summary}</td>
            <td>${report.notification_sent ? 'Sent' : 'Pending'}</td>
            <td>
                <button class="action-btn" onclick="viewReportDetails('${report._id}')">View</button>
                <button class="action-btn" onclick="resendNotification('${report._id}')">Resend</button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function viewReportDetails(reportId) {
    // Fetch the specific report details
    fetch(`/get-patient-report/${reportId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch report details');
            }
            return response.json();
        })
        .then(report => {
            // Populate the modal with report details
            document.getElementById('modal-patient-name').textContent = report.patient_name;
            document.getElementById('modal-report-date').textContent = formatDate(report.report_date);
            
            // Populate vitals
            document.getElementById('modal-blood-pressure').textContent = report.vitals.blood_pressure;
            document.getElementById('modal-heart-rate').textContent = report.vitals.heart_rate;
            document.getElementById('modal-temperature').textContent = report.vitals.temperature;
            document.getElementById('modal-oxygen-level').textContent = report.vitals.oxygen_level;
            document.getElementById('modal-glucose-level').textContent = report.vitals.glucose_level || 'Not measured';
            document.getElementById('modal-pain-level').textContent = report.vitals.pain_level;
            
            // Populate other fields
            document.getElementById('modal-medications').textContent = report.medications || 'None';
            document.getElementById('modal-health-summary').textContent = report.health_summary;
            document.getElementById('modal-nurse-notes').textContent = report.nurse_notes || 'None';
            
            // Show the modal
            document.getElementById('report-details-modal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching report details:', error);
            alert(`Error: ${error.message}`);
        });
}

function resendNotification(reportId) {
    fetch(`/resend-report-notification/${reportId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Notification resent successfully!');
            fetchPatientReports(); // Refresh the table
        } else {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error resending notification:', error);
        alert(`Error: ${error.message}`);
    });
}

    </script>

    <!-- Modal for Patient Report Details -->
    <div id="report-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="document.getElementById('report-details-modal').style.display='none'">&times;</span>
                <h3>Patient Daily Report Details</h3>
            </div>
            <div class="modal-body">
                <div class="report-details-container">
                    <div class="report-section">
                        <h4><i class="fas fa-user"></i> Patient Information</h4>
                        <p><strong>Name:</strong> <span id="modal-patient-name"></span></p>
                        <p><strong>Report Date:</strong> <span id="modal-report-date"></span></p>
                    </div>
                    
                    <div class="report-section">
                        <h4><i class="fas fa-heartbeat"></i> Vital Signs</h4>
                        <div class="vitals-grid">
                            <div class="vital-item">
                                <p><strong>Blood Pressure:</strong> <span id="modal-blood-pressure"></span> mmHg</p>
                            </div>
                            <div class="vital-item">
                                <p><strong>Heart Rate:</strong> <span id="modal-heart-rate"></span> bpm</p>
                            </div>
                            <div class="vital-item">
                                <p><strong>Temperature:</strong> <span id="modal-temperature"></span> F</p>
                            </div>
                            <div class="vital-item">
                                <p><strong>Oxygen Level:</strong> <span id="modal-oxygen-level"></span> %</p>
                            </div>
                            <div class="vital-item">
                                <p><strong>Glucose Level:</strong> <span id="modal-glucose-level"></span> mg/dL</p>
                            </div>
                            <div class="vital-item">
                                <p><strong>Pain Level:</strong> <span id="modal-pain-level"></span> /10</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-section">
                        <h4><i class="fas fa-pills"></i> Medications</h4>
                        <p id="modal-medications"></p>
                    </div>
                    
                    <div class="report-section">
                        <h4><i class="fas fa-file-medical"></i> Health Summary</h4>
                        <p id="modal-health-summary"></p>
                    </div>
                    
                    <div class="report-section">
                        <h4><i class="fas fa-clipboard"></i> Nurse's Notes</h4>
                        <p id="modal-nurse-notes"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" onclick="document.getElementById('report-details-modal').style.display='none'">Close</button>
                <button class="action-btn" id="print-report-btn" onclick="printReport()"><i class="fas fa-print"></i> Print Report</button>
            </div>
        </div>
    </div>

    <style>
        /* Additional styles for the report details modal */
        .report-details-container {
            padding: 15px;
        }
        
        .report-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .report-section h4 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .vital-item {
            background-color: white;
            padding: 10px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }
        
        #print-report-btn {
            background-color: #28a745;
        }
        
        #print-report-btn:hover {
            background-color: #218838;
        }
    </style>

    <script>
        function printReport() {
            const modalContent = document.querySelector('#report-details-modal .modal-content').cloneNode(true);
            
            // Remove the close button and print button
            modalContent.querySelector('.close').remove();
            modalContent.querySelector('.modal-footer').remove();
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Patient Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .modal-content { max-width: 800px; margin: 0 auto; }
                        .report-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                        .report-section h4 { margin-top: 0; color: #3498db; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 15px; }
                        .vitals-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
                        .vital-item { background-color: #f9f9f9; padding: 10px; border-radius: 5px; }
                        h3 { text-align: center; color: #2c3e50; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    ${modalContent.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }
    </script>

<!-- Role-Based Access Control Script -->
<script>
    // User role management
    let userRole = 'admin'; // Default role
    
    // Function to initialize role-based access control
    function initializeRBAC() {
        // Fetch the user's role from the server
        fetch('/get-hospital-details')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Get the role from the session data
                    userRole = data.data.role || 'admin';
                    console.log('User role:', userRole);
                    
                    // Apply role-based access control
                    applyRBAC();
                    
                    // If admin, load staff members
                    if (userRole === 'admin') {
                        loadStaffMembers();
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching user role:', error);
            });
    }
    
    // Function to apply role-based access control
    function applyRBAC() {
        // Hide admin-only elements for non-admin users
        if (userRole !== 'admin') {
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            adminOnlyElements.forEach(element => {
                element.style.display = 'none';
            });
            
            // Disable inventory management for nurses
            document.querySelector('button[onclick="openTab(\'inventoryManagement\')"]').style.display = 'none';
            
            // Disable available slots management for nurses
            document.querySelector('button[onclick="openTab(\'availableSlots\')"]').style.display = 'none';
        }
    }
    
    // Function to load staff members
    function loadStaffMembers() {
        fetch('/get-staff')
            .then(response => response.json())
            .then(staffMembers => {
                renderStaffTable(staffMembers);
            })
            .catch(error => {
                console.error('Error loading staff members:', error);
            });
    }
    
    // Function to render staff table
    function renderStaffTable(staffMembers) {
        const tableBody = document.getElementById('staff-table-body');
        tableBody.innerHTML = '';
        
        if (staffMembers.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="4" class="no-data">No staff members found</td>';
            tableBody.appendChild(row);
            return;
        }
        
        staffMembers.forEach(staff => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${staff.name}</td>
                <td>${staff.email}</td>
                <td>${staff.role}</td>
                <td>
                    <button class="action-btn" onclick="editStaff('${staff._id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="action-btn" onclick="deleteStaff('${staff._id}')"><i class="fas fa-trash"></i> Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    // Function to add a new staff member
    document.getElementById('add-staff-form').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const staffData = {
            name: document.getElementById('staffName').value,
            email: document.getElementById('staffEmail').value,
            password: document.getElementById('staffPassword').value,
            role: document.getElementById('staffRole').value
        };
        
        fetch('/add-staff', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(staffData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                document.getElementById('add-staff-form').reset();
                loadStaffMembers();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error adding staff member:', error);
            alert('An error occurred while adding the staff member.');
        });
    });
    
    // Function to edit a staff member
    function editStaff(staffId) {
        // This would typically open a modal with a form to edit the staff member
        alert('Edit staff member with ID: ' + staffId);
        // Implementation would be similar to adding a staff member
    }
    
    // Function to delete a staff member
    function deleteStaff(staffId) {
        if (confirm('Are you sure you want to delete this staff member?')) {
            fetch(`/delete-staff/${staffId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadStaffMembers();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting staff member:', error);
                alert('An error occurred while deleting the staff member.');
            });
        }
    }
    
    // Initialize RBAC when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeRBAC();
    });
    // Initialize monitoring tabs when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize monitoring tabs if they exist
        if (document.getElementById('healthMonitoring')) {
            initializeHealthMonitoring();
        }
        
        if (document.getElementById('patientECG')) {
            initializeECGMonitoring();
        }
    });
    
    // Health Monitoring Functions
    function initializeHealthMonitoring() {
        // Set up event listeners and initial state
        console.log('Health Monitoring initialized');
    }
    
    function updateRoomList() {
        const floor = document.getElementById('monitoringFloor').value;
        const roomSelect = document.getElementById('monitoringRoom');
        
        // Clear existing options
        while (roomSelect.options.length > 1) {
            roomSelect.remove(1);
        }
        
        // Reset patient dropdown
        const patientSelect = document.getElementById('monitoringPatient');
        while (patientSelect.options.length > 1) {
            patientSelect.remove(1);
        }
        
        if (!floor) return;
        
        // Add rooms based on selected floor (this would come from your backend in a real app)
        const roomsPerFloor = 10;
        for (let i = 1; i <= roomsPerFloor; i++) {
            const option = document.createElement('option');
            option.value = `${floor}-${i}`;
            option.textContent = `Room ${floor}-${i}`;
            roomSelect.appendChild(option);
        }
    }
    
    function loadPatientMonitoring() {
        const room = document.getElementById('monitoringRoom').value;
        const patientSelect = document.getElementById('monitoringPatient');
        const patient = patientSelect.value;
        
        if (!room) return;
        
        // If room is selected but patient isn't, populate patient dropdown
        if (room && (!patient || patientSelect.options.length <= 1)) {
            // Fetch patients in the selected room from the backend
            fetch('/get-admitted-patients')
                .then(response => response.json())
                .then(patients => {
                    // Clear existing options except the first one
                    while (patientSelect.options.length > 1) {
                        patientSelect.remove(1);
                    }
                    
                    // Filter patients by room
                    const roomPatients = patients.filter(p => p.room_id === room);
                    
                    if (roomPatients.length > 0) {
                        roomPatients.forEach(patient => {
                            const option = document.createElement('option');
                            option.value = patient._id;
                            option.textContent = `${patient.name} (${patient.age}/${patient.gender})`;
                            patientSelect.appendChild(option);
                        });
                        
                        // Automatically select the patient if there's only one in the room
                        if (roomPatients.length === 1) {
                            patientSelect.value = roomPatients[0]._id;
                            // Trigger the change event to load patient data
                            const event = new Event('change');
                            patientSelect.dispatchEvent(event);
                        }
                    } else {
                        console.log('No patients found in room:', room);
                    }
                })
                .catch(error => {
                    console.error('Error loading patients:', error);
                    // Add dummy patients for demo in case of error
                    const dummyPatients = [
                        { id: 'p1', name: 'John Doe', age: 45, gender: 'M' },
                        { id: 'p2', name: 'Jane Smith', age: 62, gender: 'F' }
                    ];
                    
                    dummyPatients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient.id;
                        option.textContent = `${patient.name} (${patient.age}/${patient.gender})`;
                        patientSelect.appendChild(option);
                    });
                });
            return;
        }
        
        // If patient is selected, load their monitoring data
        if (patient) {
            // In a real app, fetch real-time monitoring data from your backend
            // For demo, we'll simulate data
            
            // Update vital cards with random values
            document.getElementById('heartRateValue').textContent = Math.floor(70 + Math.random() * 30) + ' bpm';
            document.getElementById('oxygenValue').textContent = Math.floor(94 + Math.random() * 6) + ' %';
            document.getElementById('temperatureValue').textContent = (36.5 + Math.random() * 1.5).toFixed(1) + ' C';
            document.getElementById('bpValue').textContent = `${Math.floor(110 + Math.random() * 30)}/${Math.floor(70 + Math.random() * 20)} mmHg`;
            
            // Set random statuses
            const statuses = ['Normal', 'Warning', 'Danger'];
            const statusClasses = ['', 'warning', 'danger'];
            
            const heartRateStatus = document.getElementById('heartRateStatus');
            const heartRateIndex = Math.floor(Math.random() * 3);
            heartRateStatus.textContent = statuses[heartRateIndex];
            heartRateStatus.className = 'vital-status ' + statusClasses[heartRateIndex];
            
            const oxygenStatus = document.getElementById('oxygenStatus');
            const oxygenIndex = Math.floor(Math.random() * 3);
            oxygenStatus.textContent = statuses[oxygenIndex];
            oxygenStatus.className = 'vital-status ' + statusClasses[oxygenIndex];
            
            const tempStatus = document.getElementById('temperatureStatus');
            const tempIndex = Math.floor(Math.random() * 3);
            tempStatus.textContent = statuses[tempIndex];
            tempStatus.className = 'vital-status ' + statusClasses[tempIndex];
            
            const bpStatus = document.getElementById('bpStatus');
            const bpIndex = Math.floor(Math.random() * 3);
            bpStatus.textContent = statuses[bpIndex];
            bpStatus.className = 'vital-status ' + statusClasses[bpIndex];
            
            // In a real app, you would render a chart here using a library like Chart.js
            document.getElementById('vitalsChart').innerHTML = '<div class="placeholder-chart">Chart would be rendered here with real data</div>';
        }
    }
    
    function createDailyReport() {
        const patient = document.getElementById('monitoringPatient').value;
        if (!patient) {
            alert('Please select a patient first');
            return;
        }
        
        // Switch to Daily Reports tab and pre-fill with current patient
        openTab('patientsDailyReport');
        
        // In a real app, you would pre-select the patient in the daily report form
        // and pre-fill vitals from monitoring data
        alert('Switched to Daily Reports tab. In a real app, the form would be pre-filled with current monitoring data.');
    }
    
    function viewPatientHistory() {
        const patient = document.getElementById('monitoringPatient').value;
        if (!patient) {
            alert('Please select a patient first');
            return;
        }
        
        // In a real app, you would show a modal or navigate to a history view
        alert('In a real app, this would show the patient\'s monitoring history');
    }
    
    function triggerAlert() {
        const patient = document.getElementById('monitoringPatient').value;
        if (!patient) {
            alert('Please select a patient first');
            return;
        }
        
        // In a real app, this would trigger an alert to medical staff
        alert('Alert triggered! In a real app, this would notify medical staff about this patient.');
    }
    
    // ECG Monitoring Functions
    function initializeECGMonitoring() {
        // Set up event listeners and initial state
        console.log('ECG Monitoring initialized');
    }
    
    function updateECGRoomList() {
        const floor = document.getElementById('ecgFloor').value;
        const roomSelect = document.getElementById('ecgRoom');
        
        // Clear existing options
        while (roomSelect.options.length > 1) {
            roomSelect.remove(1);
        }
        
        // Reset patient dropdown
        const patientSelect = document.getElementById('ecgPatient');
        while (patientSelect.options.length > 1) {
            patientSelect.remove(1);
        }
        
        if (!floor) return;
        
        // First try to get rooms from beds collection
        fetch('/patient-management/api/ecg-beds')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Get beds for this floor
                const bedsOnFloor = data.beds.filter(bed => {
                    // Handle both string and integer floor values
                    return bed.floor == floor || 
                           bed.floor === parseInt(floor) || 
                           (bed.floor && floor && bed.floor.toString() === floor.toString());
                });
                
                // Get unique rooms with occupied status
                const roomsOnFloor = bedsOnFloor
                    .filter(bed => bed.status === 'occupied')
                    .map(bed => {
                        // Extract room number from bed_id (format could be G1-01, 1-01, or just 01)
                        if (bed.bed_id.includes('-')) {
                            const bedIdParts = bed.bed_id.split('-');
                            return bedIdParts.length > 1 ? bedIdParts[1] : '';
                        } else {
                            // If no dash, assume the bed_id is just the room number
                            return bed.bed_id;
                        }
                    })
                    .filter(room => room) // Filter out empty room numbers
                    .filter((room, index, self) => self.indexOf(room) === index); // Get unique rooms
                
                if (roomsOnFloor.length > 0) {
                    // Add rooms that have patients
                    roomsOnFloor.sort((a, b) => parseInt(a) - parseInt(b)); // Sort rooms numerically
                    roomsOnFloor.forEach(room => {
                        const option = document.createElement('option');
                        option.value = `${floor}-${room}`;
                        option.textContent = `Room ${floor}-${room}`;
                        roomSelect.appendChild(option);
                    });
                } else {
                    // Fallback to getting rooms from patients collection
                    return fetch('/patient-management/api/ecg-patients?floor=' + floor);
                }
            })
            .then(response => {
                if (response && response.json) {
                    return response.json();
                }
                return null;
            })
            .then(patients => {
                if (patients && Array.isArray(patients)) {
                    // If we got patients data, use it to populate rooms
                    const roomsOnFloor = patients
                        .map(p => p.room)
                        .filter(room => room && room.trim() !== '') // Filter out undefined, empty, or whitespace-only rooms
                        .filter((room, index, self) => self.indexOf(room) === index);
                    
                    if (roomsOnFloor.length > 0 && roomSelect.options.length <= 1) {
                        // Add rooms that have patients (only if we don't already have rooms)
                        roomsOnFloor.sort((a, b) => parseInt(a) - parseInt(b)); // Sort rooms numerically
                        roomsOnFloor.forEach(room => {
                            const option = document.createElement('option');
                            option.value = `${floor}-${room}`;
                            option.textContent = `Room ${floor}-${room}`;
                            roomSelect.appendChild(option);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error loading rooms:', error);
                // Fallback to static room list if API fails
                const roomsPerFloor = 10;
                for (let i = 1; i <= roomsPerFloor; i++) {
                    const option = document.createElement('option');
                    option.value = `${floor}-${i}`;
                    option.textContent = `Room ${floor}-${i}`;
                    roomSelect.appendChild(option);
                }
            });
    }
    
    function loadECGPatients() {
        const roomSelect = document.getElementById('ecgRoom');
        const room = roomSelect.value;
        const patientSelect = document.getElementById('ecgPatient');
        
        // Clear existing options except the first one
        while (patientSelect.options.length > 1) {
            patientSelect.remove(1);
        }
        
        // Clear ECG info display
        const ecgInfoElement = document.getElementById('ecgInfo');
        if (ecgInfoElement) {
            ecgInfoElement.style.display = 'none';
        }
        
        if (!room) return;
        
        // Extract floor and room number from the room value (format: "floor-room")
        const [floor, roomNumber] = room.split('-');
        
        // Fetch patients in the selected room from the backend using the new endpoint
        fetch(`/patient-management/api/ecg-patients?floor=${floor}&room=${roomNumber}`)
            .then(response => response.json())
            .then(patients => {
                if (patients.length > 0) {
                    // First add patients with ECG data
                    const patientsWithECG = patients.filter(p => p.has_ecg);
                    const patientsWithoutECG = patients.filter(p => !p.has_ecg);
                    
                    // Add patients with ECG data first
                    if (patientsWithECG.length > 0) {
                        // Sort patients with patient-specific ECG first, then sample ECG
                        patientsWithECG.sort((a, b) => {
                            // Sort by ECG type first (patient-specific before sample)
                            if (a.ecg_type === 'patient-specific' && b.ecg_type !== 'patient-specific') return -1;
                            if (a.ecg_type !== 'patient-specific' && b.ecg_type === 'patient-specific') return 1;
                            // Then sort by name
                            return a.name.localeCompare(b.name);
                        });
                        
                        patientsWithECG.forEach(patient => {
                            const option = document.createElement('option');
                            option.value = patient._id;
                            
                            // Add indicator for sample ECG data
                            const ecgTypeIndicator = patient.ecg_type === 'sample' ? ' (Sample ECG)' : '';
                            option.textContent = `${patient.name} (${patient.age}/${patient.gender})${ecgTypeIndicator}`;
                            
                            option.dataset.patientName = patient.name; // Store patient name for ECG file matching
                            option.dataset.ecgFile = patient.ecg_file; // Store matched ECG file name
                            option.dataset.ecgType = patient.ecg_type; // Store ECG type
                            patientSelect.appendChild(option);
                        });
                        
                        // Automatically select the patient if there's only one with ECG data
                        if (patientsWithECG.length === 1) {
                            patientSelect.value = patientsWithECG[0]._id;
                            // Trigger the change event to load ECG data
                            const event = new Event('change');
                            patientSelect.dispatchEvent(event);
                        }
                    }
                    
                    // Then add patients without ECG data
                    patientsWithoutECG.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient._id;
                        option.textContent = `${patient.name} (${patient.age}/${patient.gender}) - No ECG`;
                        option.dataset.patientName = patient.name;
                        patientSelect.appendChild(option);
                    });
                } else {
                    console.log('No patients found in room:', room);
                    
                    // Fallback to the old endpoint if the new one returns no results
                    fetch('/get-admitted-patients')
                        .then(response => response.json())
                        .then(allPatients => {
                            // Filter patients by room_id or floor/room combination
                            const roomPatients = allPatients.filter(p => {
                                // Match by room_id (e.g., "1-01")
                                const roomIdMatch = p.room_id === room;
                                
                                // Match by floor and room separately
                                const floorMatch = p.floor === floor || 
                                                  p.floor === parseInt(floor) || 
                                                  (p.floor && floor && p.floor.toString() === floor.toString());
                                const roomMatch = p.room === roomNumber || 
                                                 (p.room && roomNumber && p.room.toString() === roomNumber.toString());
                                
                                return roomIdMatch || (floorMatch && roomMatch);
                            });
                            
                            if (roomPatients.length > 0) {
                                // Check which patients have matching ECG files
                                fetch('/patient-management/api/available-ecg-files')
                                    .then(response => response.json())
                                    .then(ecgFiles => {
                                        roomPatients.forEach(patient => {
                                            const patientNameNormalized = patient.name.replace(/\s+/g, '').toLowerCase();
                                            
                                            // Check for exact match first
                                            const exactMatch = ecgFiles.find(file => {
                                                return file.toLowerCase() === patientNameNormalized;
                                            });
                                            
                                            // Then check for partial match
                                            const partialMatch = !exactMatch && ecgFiles.find(file => {
                                                return file.toLowerCase().includes(patientNameNormalized);
                                            });
                                            
                                            // Use AAMI sample if no match
                                            const sampleFile = !exactMatch && !partialMatch && ecgFiles.find(file => {
                                                return file.toLowerCase().startsWith('aami');
                                            });
                                            
                                            const matchedFile = exactMatch || partialMatch || sampleFile;
                                            const hasEcg = !!matchedFile;
                                            const ecgType = matchedFile ? 
                                                (matchedFile.toLowerCase().startsWith('aami') ? 'sample' : 'patient-specific') : '';
                                            
                                            const option = document.createElement('option');
                                            // Store patient name as the value instead of ID to prioritize name-based ECG lookup
                                            // We'll still keep the ID in a data attribute for reference
                                            option.value = patient._id;
                                            option.dataset.patientId = patient._id;
                                            
                                            // Add indicator for sample ECG data
                                            const ecgTypeIndicator = hasEcg && ecgType === 'sample' ? ' (Sample ECG)' : 
                                                                    !hasEcg ? ' - No ECG' : ' (Patient-specific ECG)';
                                            option.textContent = `${patient.name} (${patient.age}/${patient.gender})${ecgTypeIndicator}`;
                                            
                                            option.dataset.patientName = patient.name;
                                            if (matchedFile) {
                                                option.dataset.ecgFile = matchedFile;
                                                option.dataset.ecgType = ecgType;
                                            }
                                            patientSelect.appendChild(option);
                                        });
                                    })
                                    .catch(error => {
                                        console.error('Error checking ECG files:', error);
                                        // Just show all patients without ECG status
                                        roomPatients.forEach(patient => {
                                            const option = document.createElement('option');
                                            option.value = patient._id;
                                            option.dataset.patientId = patient._id;
                                            option.textContent = `${patient.name} (${patient.age}/${patient.gender}) - No ECG info`;
                                            option.dataset.patientName = patient.name;
                                            patientSelect.appendChild(option);
                                        });
                                    });
                            }
                        })
                        .catch(error => {
                            console.error('Error loading patients from fallback:', error);
                        });
                }
            })
            .catch(error => {
                console.error('Error loading patients:', error);
                // Add dummy patients for demo in case of error
                const dummyPatients = [
                    { id: 'p1', name: 'John Doe', age: 45, gender: 'M', ecg_file: 'aami3d', ecg_type: 'sample' },
                    { id: 'p2', name: 'Jane Smith', age: 62, gender: 'F', ecg_file: 'aami4a', ecg_type: 'sample' }
                ];
                
                dummyPatients.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.id;
                    option.dataset.patientId = patient.id;
                    option.textContent = `${patient.name} (${patient.age}/${patient.gender}) (Sample ECG)`;
                    option.dataset.patientName = patient.name;
                    option.dataset.ecgFile = patient.ecg_file;
                    option.dataset.ecgType = patient.ecg_type;
                    patientSelect.appendChild(option);
                });
            });
    }
    
    function loadECGData() {
        const patientSelect = document.getElementById('ecgPatient');
        const patientId = patientSelect.value;
        
        if (!patientId) return;
        
        // Get the selected option to access the patient name
        const selectedOption = patientSelect.options[patientSelect.selectedIndex];
        const patientName = selectedOption.dataset.patientName || selectedOption.textContent.split(' (')[0];
        
        // Show loading indicator with patient name
        const ecgChart = document.getElementById('ecgChart');
        ecgChart.innerHTML = '<div class="loading-indicator">Loading ECG data for <strong>' + patientName + '</strong>...</div>';
        
        // Prioritize using patient name for ECG data fetching
        // The patient_id is included as a fallback
        console.log(`Fetching ECG data for patient: ${patientName}`);
        fetch(`/patient-management/api/ecg?patient=${encodeURIComponent(patientName)}&patient_id=${encodeURIComponent(patientId)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch ECG data');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show sample data notice if using default ECG
                const ecgInfoElement = document.getElementById('ecgInfo');
                if (ecgInfoElement) {
                    if (data.is_sample) {
                        ecgInfoElement.innerHTML = '<div class="alert alert-info">Using <strong>sample ECG data</strong>. No patient-specific ECG available for <strong>' + patientName + '</strong>.</div>';
                        ecgInfoElement.style.display = 'block';
                    } else {
                        ecgInfoElement.innerHTML = '<div class="alert alert-success">Using <strong>patient-specific ECG data</strong> for <strong>' + patientName + '</strong>.</div>';
                        ecgInfoElement.style.display = 'block';
                    }
                }
                
                // Render the ECG waveform using Canvas
                renderECGWaveform(data);
                
                // Update ECG stats based on the data
                // Calculate heart rate from the ECG data
                const heartRate = calculateHeartRate(data.ecg, data.fs);
                document.getElementById('ecgHeartRate').textContent = heartRate + ' bpm';
                
                // For other metrics, we could calculate them from the ECG data
                // but for now we'll use values based on the heart rate
                const qrsDuration = Math.floor(80 + (heartRate > 100 ? -10 : heartRate < 60 ? 10 : 0) + Math.random() * 20);
                const prInterval = Math.floor(120 + (heartRate > 100 ? -20 : heartRate < 60 ? 20 : 0) + Math.random() * 30);
                const qtInterval = Math.floor(350 + (heartRate > 100 ? -30 : heartRate < 60 ? 30 : 0) + Math.random() * 20);
                
                document.getElementById('qrsDuration').textContent = qrsDuration + ' ms';
                document.getElementById('prInterval').textContent = prInterval + ' ms';
                document.getElementById('qtInterval').textContent = qtInterval + ' ms';
                
                // Update the analysis based on the heart rate
                updateECGAnalysis(heartRate);
                
                // Store patient data in the database (if needed)
                // This could be implemented to save the ECG reading to the patient's record
            })
            .catch(error => {
                console.error(`Error loading ECG data for ${patientName}:`, error);
                
                // Show error message in the ECG chart area
                const ecgChart = document.getElementById('ecgChart');
                ecgChart.innerHTML = `<div class="alert alert-danger">Error loading ECG data for <strong>${patientName}</strong>: ${error.message}</div>`;
                
                // Show error in ECG info area as well
                const ecgInfoElement = document.getElementById('ecgInfo');
                if (ecgInfoElement) {
                    ecgInfoElement.innerHTML = `<div class="alert alert-danger">Failed to load ECG data for <strong>${patientName}</strong>. Please try again or contact support.</div>`;
                    ecgInfoElement.style.display = 'block';
                }
            });
    }
    
    // Function to calculate heart rate from ECG data
    function calculateHeartRate(ecgData, samplingRate) {
        // This is a more realistic heart rate calculation based on the ECG data
        // It detects peaks in the ECG signal and calculates the heart rate
        
        // First, normalize the data
        const mean = ecgData.reduce((sum, val) => sum + val, 0) / ecgData.length;
        const normalized = ecgData.map(val => val - mean);
        
        // Find peaks (R waves) - simple threshold-based detection
        const threshold = 0.6 * Math.max(...normalized.map(Math.abs));
        const peaks = [];
        
        // Minimum distance between peaks (to avoid detecting the same peak twice)
        const minDistance = Math.floor(samplingRate * 0.2); // 200ms minimum between peaks
        
        for (let i = 1; i < normalized.length - 1; i++) {
            if (normalized[i] > threshold && normalized[i] > normalized[i-1] && normalized[i] > normalized[i+1]) {
                // Found a peak
                if (peaks.length === 0 || i - peaks[peaks.length - 1] > minDistance) {
                    peaks.push(i);
                }
            }
        }
        
        // Calculate average RR interval and convert to heart rate
        if (peaks.length < 2) {
            // Not enough peaks detected, return a reasonable default
            return Math.floor(70 + Math.random() * 20);
        }
        
        // Calculate intervals between peaks
        const intervals = [];
        for (let i = 1; i < peaks.length; i++) {
            intervals.push(peaks[i] - peaks[i-1]);
        }
        
        // Average interval in samples
        const avgInterval = intervals.reduce((sum, val) => sum + val, 0) / intervals.length;
        
        // Convert to heart rate: HR = 60 * sampling_rate / avg_interval
        const heartRate = Math.round(60 * samplingRate / avgInterval);
        
        // Sanity check - heart rates are typically between 40 and 200 bpm
        if (heartRate < 40 || heartRate > 200) {
            return Math.floor(70 + Math.random() * 20); // Return a reasonable default
        }
        
        // Add a small random variation to make it look more realistic
        const variation = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
        return heartRate + variation;
    }
    
    // Function to update ECG analysis based on heart rate
    function updateECGAnalysis(heartRate) {
        let analysis = '';
        
        if (heartRate < 60) {
            analysis = 'Bradycardia detected. Heart rate below normal range.';
        } else if (heartRate > 100) {
            analysis = 'Tachycardia detected. Heart rate above normal range.';
        } else {
            analysis = 'Normal sinus rhythm. Heart rate within normal range.';
        }
        
        document.getElementById('ecgAnalysis').innerHTML = `<p>${analysis}</p>`;
    }
        
        // Analysis is now handled by updateECGAnalysis function
    
    // Function to render the ECG waveform using Canvas
    function renderECGWaveform(data) {
        // Stop any existing animation
        stopECGAnimation();
        
        const ecgChart = document.getElementById('ecgChart');
        ecgChart.innerHTML = ''; // Clear previous content
        
        // Create canvas element
        const canvas = document.createElement('canvas');
        canvas.width = ecgChart.clientWidth;
        canvas.height = 200;
        ecgChart.appendChild(canvas);
        
        const ctx = canvas.getContext('2d');
        const ecgData = data.ecg;
        
        // Store the ECG data globally
        currentECGData = ecgData;
        
        // Create a more realistic ECG by adding variations
        const enhancedData = enhanceECGData(ecgData);
        
        // Add grid lines
        drawECGGrid(ctx, canvas.width, canvas.height);
        
        // Set up animation variables
        let position = 0;
        const visiblePoints = Math.min(500, enhancedData.length); // Number of points visible at once
        
        // Calculate scaling factors
        const xStep = canvas.width / visiblePoints;
        const yMiddle = canvas.height / 2;
        const yScale = canvas.height / 4; // Scale to fit in canvas
        
        // Function to draw the current frame of the ECG
        function drawECG() {
            // Clear the canvas (except grid)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Redraw the grid
            drawECGGrid(ctx, canvas.width, canvas.height);
            
            // Draw the ECG line
            ctx.beginPath();
            ctx.strokeStyle = '#00cc00'; // Green color for ECG
            ctx.lineWidth = 2;
            
            // Calculate the starting index based on current position
            const startIdx = Math.floor(position);
            
            // Draw visible portion of the ECG
            for (let i = 0; i < visiblePoints; i++) {
                const dataIdx = (startIdx + i) % enhancedData.length;
                const x = i * xStep;
                const y = yMiddle - (enhancedData[dataIdx] * yScale);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Add a blinking dot to simulate the real-time monitoring
            const lastDataIdx = (startIdx + visiblePoints - 1) % enhancedData.length;
            const lastX = (visiblePoints - 1) * xStep;
            const lastY = yMiddle - (enhancedData[lastDataIdx] * yScale);
            
            ctx.beginPath();
            ctx.arc(lastX, lastY, 3, 0, Math.PI * 2);
            ctx.fillStyle = '#ff0000'; // Red dot
            ctx.fill();
            
            // Update position for next frame based on current speed setting
            position = (position + currentECGSpeed) % enhancedData.length;
            
            // Request next animation frame
            ecgAnimationFrame = requestAnimationFrame(drawECG);
        }
        
        // Start the animation
        drawECG();
        
        // Add cleanup on tab change or when component is unmounted
        const cleanupAnimation = () => {
            stopECGAnimation();
        };
        
        // Clean up animation when switching tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', cleanupAnimation);
        });
        
        // Clean up when the window is unloaded
        window.addEventListener('beforeunload', cleanupAnimation);
    }
    
    // Function to enhance ECG data to make it more realistic
    function enhanceECGData(originalData) {
        // Create a copy of the original data
        const enhancedData = [...originalData];
        
        // Add some randomness to simulate natural variation
        for (let i = 0; i < enhancedData.length; i++) {
            // Add small random variations (5% of the value)
            enhancedData[i] = enhancedData[i] * (1 + (Math.random() * 0.1 - 0.05));
        }
        
        // Add periodic variations to simulate breathing effects
        const breathingCycle = Math.floor(enhancedData.length / 5); // 5 breathing cycles per ECG
        for (let i = 0; i < enhancedData.length; i++) {
            const breathingEffect = Math.sin(i * 2 * Math.PI / breathingCycle) * 0.05;
            enhancedData[i] += breathingEffect;
        }
        
        // For seamless looping, blend the end with the beginning
        const blendPoints = Math.min(50, Math.floor(enhancedData.length / 10));
        for (let i = 0; i < blendPoints; i++) {
            const weight = i / blendPoints;
            enhancedData[enhancedData.length - blendPoints + i] = 
                enhancedData[enhancedData.length - blendPoints + i] * (1 - weight) + 
                enhancedData[i] * weight;
        }
        
        // Add the beginning to the end for seamless looping
        const seamlessPoints = Math.min(100, Math.floor(enhancedData.length / 4));
        enhancedData.push(...enhancedData.slice(0, seamlessPoints));
        
        return enhancedData;
    }
    
    // Function to draw ECG grid
    function drawECGGrid(ctx, width, height) {
        ctx.strokeStyle = 'rgba(200, 200, 200, 0.5)';
        ctx.lineWidth = 0.5;
        
        // Draw horizontal grid lines
        const yStep = height / 10;
        for (let y = 0; y <= height; y += yStep) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
        }
        
        // Draw vertical grid lines
        const xStep = width / 20;
        for (let x = 0; x <= width; x += xStep) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
        }
    }
    
    function printECG() {
        const patient = document.getElementById('ecgPatient').value;
        if (!patient) {
            alert('Please select a patient first');
            return;
        }
        
        // In a real app, this would generate a printable ECG report
        alert('In a real app, this would generate a printable ECG report');
    }
    
    function saveECGReport() {
        const patient = document.getElementById('ecgPatient').value;
        if (!patient) {
            alert('Please select a patient first');
            return;
        }
        
        // In a real app, this would save the ECG report to the patient's records
        alert('ECG report saved! In a real app, this would be saved to the patient\'s medical records.');
    }
    
    function triggerECGAlert() {
        const patient = document.getElementById('ecgPatient').value;
        if (!patient) {
            alert('Please select a patient first');
            return;
        }
        
        // In a real app, this would trigger an alert to medical staff
        alert('ECG Alert triggered! In a real app, this would notify medical staff about this patient\'s ECG abnormalities.');
    }

    // Dashboard initialization function
    function initializeDashboard() {
        // Fetch hospital details for dashboard
        fetchHospitalDetailsForDashboard();
        
        // Fetch real metrics from the backend
        updateDashboardMetrics();
        
        // Fetch OPD prediction data
        fetchOPDPrediction();
    }
    
    // Function to fetch and display OPD prediction data
    function fetchOPDPrediction() {
        console.log('[DEBUG] Starting fetchOPDPrediction function');
        console.log('[DEBUG] Fetching from /predict-opd-appointments endpoint');
        
        fetch('/predict-opd-appointments')
            .then(response => {
                console.log(`[DEBUG] Response status: ${response.status}`);
                console.log(`[DEBUG] Response headers:`, response.headers);
                
                if (!response.ok) {
                    console.error(`[DEBUG] Response not OK: ${response.status} ${response.statusText}`);
                    throw new Error(`Failed to fetch OPD prediction data: ${response.status} ${response.statusText}`);
                }
                
                console.log('[DEBUG] Response OK, parsing JSON');
                return response.json().then(data => {
                    console.log('[DEBUG] Parsed JSON data:', data);
                    return data;
                });
            })
            .then(data => {
                console.log('[DEBUG] Processing prediction data');
                // Get the prediction section elements
                const predictionHeader = document.querySelector('.prediction-header .overall-forecast');
                const predictionBars = document.querySelector('.prediction-bars');
                
                console.log('[DEBUG] Found DOM elements:', {
                    predictionHeader: predictionHeader ? 'Found' : 'Not found',
                    predictionBars: predictionBars ? 'Found' : 'Not found'
                });
                
                if (!data.prediction) {
                    console.error('[DEBUG] No prediction data available in response:', data);
                    return;
                }
                
                console.log('[DEBUG] Prediction data:', data.prediction);
                
                // Update overall forecast
                if (predictionHeader) {
                    console.log(`[DEBUG] Setting overall forecast to: ${data.prediction.overall}`);
                    predictionHeader.textContent = data.prediction.overall;
                    
                    // Set color class based on volume level
                    predictionHeader.className = 'overall-forecast';
                    if (data.prediction.overall.toLowerCase().includes('high')) {
                        console.log('[DEBUG] Adding high-volume class');
                        predictionHeader.classList.add('high-volume');
                    } else if (data.prediction.overall.toLowerCase().includes('medium')) {
                        console.log('[DEBUG] Adding medium-volume class');
                        predictionHeader.classList.add('medium-volume');
                    } else {
                        console.log('[DEBUG] Adding low-volume class');
                        predictionHeader.classList.add('low-volume');
                    }
                }
                
                // Update prediction bars
                if (predictionBars) {
                    console.log('[DEBUG] Updating prediction bars');
                    // Clear existing content
                    predictionBars.innerHTML = '';
                    
                    // Create morning prediction bar
                    const morningData = data.prediction.morning;
                    console.log('[DEBUG] Morning data:', morningData);
                    const morningBar = createPredictionBar('Morning (9AM-12PM)', morningData.count, morningData.level);
                    predictionBars.appendChild(morningBar);
                    
                    // Create afternoon prediction bar
                    const afternoonData = data.prediction.afternoon;
                    console.log('[DEBUG] Afternoon data:', afternoonData);
                    const afternoonBar = createPredictionBar('Afternoon (12PM-4PM)', afternoonData.count, afternoonData.level);
                    predictionBars.appendChild(afternoonBar);
                    
                    // Create evening prediction bar
                    const eveningData = data.prediction.evening;
                    console.log('[DEBUG] Evening data:', eveningData);
                    const eveningBar = createPredictionBar('Evening (4PM-8PM)', eveningData.count, eveningData.level);
                    predictionBars.appendChild(eveningBar);
                    
                    console.log('[DEBUG] Prediction bars updated successfully');
                }
            })
            .catch(error => {
                console.error('[DEBUG] Error fetching OPD prediction:', error);
                console.error('[DEBUG] Error stack:', error.stack);
                // Fallback to static data if API fails
                console.log('[DEBUG] Using fallback static data for OPD prediction');
            });
    }
    
    // Helper function to create prediction bar elements
    function createPredictionBar(timeLabel, count, level) {
        // Calculate width percentage based on count (max 100%)
        const widthPercentage = Math.min(Math.max(count, 5), 100); // At least 5% width for visibility
        
        // Create container div
        const container = document.createElement('div');
        container.className = 'prediction-time-slot';
        
        // Create time label
        const timeLabelDiv = document.createElement('div');
        timeLabelDiv.className = 'time-label';
        timeLabelDiv.textContent = timeLabel;
        container.appendChild(timeLabelDiv);
        
        // Create prediction bar container
        const barContainerDiv = document.createElement('div');
        barContainerDiv.className = 'prediction-bar-container';
        container.appendChild(barContainerDiv);
        
        // Create prediction bar
        const barDiv = document.createElement('div');
        barDiv.className = `prediction-bar ${level}`;
        barDiv.style.width = `${widthPercentage}%`;
        barDiv.textContent = `${count} patients`;
        barContainerDiv.appendChild(barDiv);
        
        return container;
    }
    
    // This function is now a wrapper that calls fetchHospitalDetails
    // This function is now defined at the top of the script
    // to avoid being called before it's defined
    
    // Fetch OPD prediction data and update the display
    function fetchOPDPrediction(showLoader = false) {
        // Show loading state if requested
        if (showLoader) {
            document.getElementById('overall-forecast').textContent = 'Loading...';
            document.getElementById('morning-bar').textContent = 'Loading...';
            document.getElementById('afternoon-bar').textContent = 'Loading...';
            document.getElementById('evening-bar').textContent = 'Loading...';
        }
        
        // Fetch prediction data from the backend
        fetch('/predict-opd-appointments')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch OPD prediction data');
                }
                return response.json();
            })
            .then(data => {
                console.log('[DEBUG] Processing prediction data:', data);
                const prediction = data.prediction;
                
                // Update overall forecast
                const overallForecast = document.getElementById('overall-forecast');
                overallForecast.textContent = prediction.overall;
                
                // Set background color based on forecast level
                if (prediction.overall.includes('High')) {
                    overallForecast.style.backgroundColor = 'var(--danger-color)';
                } else if (prediction.overall.includes('Medium')) {
                    overallForecast.style.backgroundColor = 'var(--warning-color)';
                } else {
                    overallForecast.style.backgroundColor = 'var(--success-color)';
                }
                
                // Calculate total patients for percentage calculation
                const totalPatients = prediction.morning.count + prediction.afternoon.count + prediction.evening.count;
                const maxPatients = Math.max(prediction.morning.count, prediction.afternoon.count, prediction.evening.count);
                console.log('[DEBUG] Total patients:', totalPatients, 'Max patients:', maxPatients);
                
                // Update morning bar
                updatePredictionBar('morning-bar', prediction.morning.count, prediction.morning.level, maxPatients);
                
                // Update afternoon bar
                updatePredictionBar('afternoon-bar', prediction.afternoon.count, prediction.afternoon.level, maxPatients);
                
                // Update evening bar
                updatePredictionBar('evening-bar', prediction.evening.count, prediction.evening.level, maxPatients);
            })
            .catch(error => {
                console.error('Error fetching OPD prediction:', error);
                // Show error state
                document.getElementById('overall-forecast').textContent = 'Data unavailable';
                document.getElementById('morning-bar').textContent = 'Error loading data';
                document.getElementById('afternoon-bar').textContent = 'Error loading data';
                document.getElementById('evening-bar').textContent = 'Error loading data';
            });
    }
    
    // Helper function to update a prediction bar with count, level, and percentage
    function updatePredictionBar(barId, count, level, maxPatients) {
        const bar = document.getElementById(barId);
        if (!bar) {
            console.error(`[DEBUG] Bar element with ID ${barId} not found`);
            return;
        }
        
        console.log(`[DEBUG] Updating bar ${barId} with count=${count}, level=${level}, maxPatients=${maxPatients}`);
        
        // Calculate percentage based on max patients (avoid division by zero)
        // This ensures bars are sized relative to the largest value for better visualization
        const percentage = maxPatients > 0 ? Math.round((count / maxPatients) * 100) : 0;
        
        // Set bar width based on percentage (minimum 5% for visibility when count > 0)
        const displayWidth = count > 0 ? Math.max(12, percentage) : 0;
        console.log(`[DEBUG] Setting ${barId} width to ${displayWidth}%`);
        bar.style.width = `${displayWidth}%`;
        
        // Set bar class based on level
        bar.className = `prediction-bar ${level.toLowerCase()}`;
        
        // Set bar text to show count and percentage
        bar.textContent = `${count} patients (${percentage}%)`;
        
        // Make sure the bar is visible
        bar.style.display = 'flex';
        
        // Ensure text is visible by setting a minimum width for text display
        if (displayWidth < 30) {
            // For small bars, make the text overflow the bar but still be visible
            bar.style.minWidth = '120px';
            bar.style.overflow = 'visible';
            bar.style.color = '#f0f0f0';
            bar.style.textShadow = '0 0 2px #000';
        }
    }
    
    // Update dashboard metrics function is now defined at the top of the script
    
    // Slots tabs navigation
    function initializeSlotsTabsNavigation() {
        // Set the first tab (doctorSlots) as active by default
        openSlotsTab('doctorSlots');
    }
    
    // Function to open slots tab
    function openSlotsTab(tabId) {
        // Hide all slots tab content
        const tabContents = document.getElementsByClassName('slots-tab-content');
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove('active');
        }
        
        // Remove active class from all tabs
        const tabs = document.getElementsByClassName('slots-tab');
        for (let i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }
        
        // Show the selected tab content
        document.getElementById(tabId).classList.add('active');
        
        // Add active class to the clicked tab
        // Find the button that opens this tab and add active class
        const buttons = document.querySelectorAll('.slots-tab');
        buttons.forEach(button => {
            if (button.getAttribute('onclick').includes(tabId)) {
                button.classList.add('active');
            }
        });
        
        // If bed slots tab is selected, initialize bed view
        if (tabId === 'bedSlots') {
            initializeBedView();
        }
    }
    
    // Initialize bed view
    function initializeBedView() {
        // Get saved view type or default to 'byFloor'
        const savedViewType = localStorage.getItem('bedViewType') || 'byFloor';
        
        // Set the active button
        const viewButtons = document.getElementsByClassName('bed-view-btn');
        for (let i = 0; i < viewButtons.length; i++) {
            if (viewButtons[i].getAttribute('onclick').includes(savedViewType)) {
                viewButtons[i].classList.add('active');
            } else {
                viewButtons[i].classList.remove('active');
            }
        }
        
        // Fetch bed data from backend with the saved view type
        fetchBedData(savedViewType);
    }
    
    // Fetch bed data from the server
    function fetchBedData(viewType = 'byFloor') {
        fetch('/bed_availability')
            .then(response => response.json())
            .then(data => {
                if (data.beds_by_floor) {
                    // Clear existing bed containers
                    const bedContainer = document.querySelector('.bed-availability-container');
                    bedContainer.innerHTML = '';
                    
                    // Add bed summary section
                    const summaryHTML = `
                        <div class="bed-summary">
                            <div class="summary-item">
                                <div class="summary-label">Total Beds</div>
                                <div class="summary-value" id="total-beds">${data.summary.total}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Available</div>
                                <div class="summary-value" id="available-beds">${data.summary.available}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Occupied</div>
                                <div class="summary-value" id="occupied-beds">${data.summary.occupied}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Reserved</div>
                                <div class="summary-value" id="reserved-beds">${data.summary.reserved}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Maintenance</div>
                                <div class="summary-value" id="maintenance-beds">${data.summary.maintenance}</div>
                            </div>
                        </div>
                    `;
                    bedContainer.innerHTML = summaryHTML;
                    
                    if (viewType === 'byFloor') {
                        // Group beds by floor
                        Object.keys(data.beds_by_floor).sort().forEach(floor => {
                            const floorContainer = document.createElement('div');
                            floorContainer.className = 'floor-container';
                            floorContainer.innerHTML = `<h3>Floor ${floor}</h3>`;
                            
                            const bedsGrid = document.createElement('div');
                            bedsGrid.className = 'beds-grid';
                            
                            // Add beds to the grid
                            data.beds_by_floor[floor].forEach(bed => {
                                const bedCard = createBedCard(bed);
                                bedsGrid.appendChild(bedCard);
                            });
                            
                            floorContainer.appendChild(bedsGrid);
                            bedContainer.appendChild(floorContainer);
                        });
                    } else if (viewType === 'byWard') {
                        // Group beds by type (ward)
                        const bedsByType = {};
                        
                        // Organize beds by type
                        Object.values(data.beds_by_floor).forEach(floorBeds => {
                            floorBeds.forEach(bed => {
                                if (!bedsByType[bed.bed_type]) {
                                    bedsByType[bed.bed_type] = [];
                                }
                                bedsByType[bed.bed_type].push(bed);
                            });
                        });
                        
                        // Create ward containers
                        Object.keys(bedsByType).sort().forEach(type => {
                            const wardContainer = document.createElement('div');
                            wardContainer.className = 'floor-container';
                            wardContainer.innerHTML = `<h3>${type} Ward</h3>`;
                            
                            const bedsGrid = document.createElement('div');
                            bedsGrid.className = 'beds-grid';
                            
                            // Add beds to the grid
                            bedsByType[type].forEach(bed => {
                                const bedCard = createBedCard(bed);
                                bedsGrid.appendChild(bedCard);
                            });
                            
                            wardContainer.appendChild(bedsGrid);
                            bedContainer.appendChild(wardContainer);
                        });
                    }
                } else {
                    // Fallback for old data format
                    console.log('Using fallback data format:', data);
                    alert('Unable to load bed data. Please contact support.');
                }
            })
            .catch(error => {
                console.error('Error fetching bed data:', error);
                alert('Error loading bed data. Please try again later.');
            });
    }
    
    // Helper function to create a bed card
     function createBedCard(bed) {
         const bedCard = document.createElement('div');
         bedCard.className = 'bed-card';
         bedCard.innerHTML = `
             <div class="bed-icon ${bed.status}"><i class="fas fa-bed"></i></div>
             <div class="bed-details">
                 <div class="bed-id">${bed.bed_id}</div>
                 <div class="bed-type">${bed.bed_type}</div>
                 <div class="bed-status ${bed.status}">${bed.status}</div>
             </div>
         `;
         
         // Add click event to update bed status
         bedCard.addEventListener('click', () => updateBedStatus(bed.bed_id, bed.status));
         
         return bedCard;
     }
    
    // Function to update bed status
    function updateBedStatus(bedId, currentStatus) {
        // Create options for the new status
        const statuses = ['available', 'occupied', 'reserved', 'maintenance'];
        const options = statuses.map(status => 
            `<option value="${status}" ${status === currentStatus ? 'selected' : ''}>${status.charAt(0).toUpperCase() + status.slice(1)}</option>`
        ).join('');
        
        // Show a modal or prompt for the new status
        const newStatus = prompt(`Update status for bed ${bedId}:\nCurrent status: ${currentStatus}\n\nEnter new status (available, occupied, reserved, maintenance):`, currentStatus);
        
        if (newStatus && statuses.includes(newStatus.toLowerCase())) {
            // Send update to server
            fetch('/update_bed_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    bed_id: bedId,
                    status: newStatus.toLowerCase()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    alert('Bed status updated successfully!');
                    // Refresh the bed data
                    fetchBedData();
                    
                    // Refresh the bed type dropdown to show updated availability
                    populateBedTypeDropdown();
                }
            })
            .catch(error => {
                console.error('Error updating bed status:', error);
                alert('An error occurred while updating the bed status.');
            });
        } else if (newStatus) {
            alert('Invalid status. Please use one of: available, occupied, reserved, maintenance');
        }
    }
    
    // Toggle bed view between floor and ward
    function toggleBedView(viewType) {
        // Remove active class from all view buttons
        const viewButtons = document.getElementsByClassName('bed-view-btn');
        for (let i = 0; i < viewButtons.length; i++) {
            viewButtons[i].classList.remove('active');
        }
        
        // Add active class to the clicked button
        const buttons = document.querySelectorAll('.bed-view-btn');
        buttons.forEach(button => {
            if (button.getAttribute('onclick').includes(viewType)) {
                button.classList.add('active');
            }
        });
        
        // Store the current view type
        localStorage.setItem('bedViewType', viewType);
        
        // Refresh the bed data with the new view type
        fetchBedData(viewType);
    }
</script>

<!-- Health Monitoring Tab Content -->
<div id="healthMonitoring" class="tab-content">
    <div class="patient-form-section">
        <h2><i class="fas fa-heartbeat"></i> Patient Health Monitoring</h2>
        
        <div class="monitoring-controls">
            <div class="form-row">
                <div class="form-group">
                    <label for="monitoringFloor"><i class="fas fa-building"></i> Floor</label>
                    <select id="monitoringFloor" onchange="healthMonitor_updateRoomList()">
                        <option value="">Select Floor</option>
                        <option value="1">Floor 1</option>
                        <option value="2">Floor 2</option>
                        <option value="3">Floor 3</option>
                        <option value="4">Floor 4</option>
                        <option value="5">Floor 5</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="monitoringRoom"><i class="fas fa-door-open"></i> Room</label>
                    <select id="monitoringRoom" onchange="healthMonitor_loadPatients()">
                        <option value="">Select Room</option>
                        <!-- Rooms will be populated based on floor selection -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="monitoringPatient"><i class="fas fa-user-injured"></i> Patient</label>
                    <select id="monitoringPatient" onchange="healthMonitor_startMonitoring(this.value)">
                        <option value="">Select Patient</option>
                        <!-- Patients will be populated based on room selection -->
                    </select>
                </div>
            </div>
        </div>
        
        <div class="monitoring-dashboard">
            <div class="vital-cards">
                <div class="vital-card">
                    <div class="vital-icon"><i class="fas fa-heartbeat"></i></div>
                    <div class="vital-info">
                        <h3>Heart Rate</h3>
                        <div class="vital-value" id="heartRateValue">-- bpm</div>
                        <div class="vital-status" id="heartRateStatus">Normal</div>
                    </div>
                </div>
                
                <div class="vital-card">
                    <div class="vital-icon"><i class="fas fa-lungs"></i></div>
                    <div class="vital-info">
                        <h3>Oxygen Level</h3>
                        <div class="vital-value" id="oxygenValue">-- %</div>
                        <div class="vital-status" id="oxygenStatus">Normal</div>
                    </div>
                </div>
                
                <div class="vital-card">
                    <div class="vital-icon"><i class="fas fa-thermometer-half"></i></div>
                    <div class="vital-info">
                        <h3>Temperature</h3>
                        <div class="vital-value" id="temperatureValue">-- C</div>
                        <div class="vital-status" id="temperatureStatus">Normal</div>
                    </div>
                </div>
                
                <div class="vital-card">
                    <div class="vital-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="vital-info">
                        <h3>Blood Pressure</h3>
                        <div class="vital-value" id="bpValue">--/-- mmHg</div>
                        <div class="vital-status" id="bpStatus">Normal</div>
                    </div>
                </div>
            </div>
            
            <div class="monitoring-charts">
                <div class="chart-container">
                    <h3>Vitals Trend (Last 60 Seconds)</h3>
                    <div class="chart" id="vitalsChart">
                        <!-- Chart will be rendered here -->
                        <canvas id="vitalsChartCanvas"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="monitoring-actions">
                <button class="action-btn" onclick="healthMonitor_createDailyReport()"><i class="fas fa-notes-medical"></i> Create Daily Report</button>
                <button class="action-btn" onclick="healthMonitor_viewPatientHistory()"><i class="fas fa-history"></i> View Patient History</button>
                <button class="action-btn danger" onclick="healthMonitor_triggerAlert()"><i class="fas fa-exclamation-triangle"></i> Trigger Alert</button>
            </div>
        </div>
    </div>
</div>

<!-- ECG Monitoring Tab Content -->
<div id="patientECG" class="tab-content">
    <div class="patient-form-section">
        <h2><i class="fas fa-wave-square"></i> ECG Monitoring</h2>
        
        <div class="monitoring-controls">
            <div class="form-row">
                <div class="form-group">
                    <label for="ecgFloor"><i class="fas fa-building"></i> Floor</label>
                    <select id="ecgFloor" onchange="updateECGRoomList()">
                        <option value="">Select Floor</option>
                        <!-- Floors will be populated from beds collection -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ecgRoom"><i class="fas fa-door-open"></i> Bed ID</label>
                    <select id="ecgRoom" onchange="loadECGPatients()">
                        <option value="">Select Bed</option>
                        <!-- Beds will be populated based on floor selection -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ecgPatient"><i class="fas fa-user-injured"></i> Patient</label>
                    <select id="ecgPatient" onchange="loadECGData()">
                        <option value="">Select Patient</option>
                        <!-- Patients will be populated based on bed selection -->
                    </select>
                </div>
            </div>
            
            <div class="form-row" style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px;">
                <div class="form-group" style="flex: 2;">
                    <label for="directPatientName"><i class="fas fa-search"></i> Search by Patient Name</label>
                    <input type="text" id="directPatientName" class="form-control" placeholder="Enter patient name">
                </div>
                <div class="form-group" style="flex: 1; display: flex; align-items: flex-end;">
                    <button class="action-btn" style="margin-left: 10px; height: 38px;" onclick="loadECGByPatientName(document.getElementById('directPatientName').value)"><i class="fas fa-heartbeat"></i> Load ECG</button>
                </div>
            </div>
            
            <div id="ecgInfo" style="margin-top: 10px; display: none;"></div>
        </div>
        
        <div class="ecg-dashboard">
            <div class="ecg-container">
                <h3>Real-time ECG</h3>
                <div class="ecg-chart" id="ecgChart">
                    <!-- ECG chart will be rendered here -->
                    <div class="placeholder-chart">Select a patient to view ECG</div>
                </div>
                <div class="ecg-controls">
                    <label for="ecgSpeed">Animation Speed: <span id="ecgSpeedValue">2x</span></label>
                    <input type="range" id="ecgSpeed" min="0.5" max="5" step="0.5" value="2" class="slider" oninput="updateECGSpeed(this.value)">
                    <button class="action-btn" onclick="toggleECGPause()" id="ecgPauseBtn"><i class="fas fa-pause"></i> Pause</button>
                </div>
                <style>
                    .ecg-controls {
                        display: flex;
                        align-items: center;
                        margin-top: 10px;
                        gap: 15px;
                    }
                    .ecg-controls label {
                        display: inline-block;
                        min-width: 180px;
                    }
                    .ecg-controls .slider {
                        flex: 1;
                    }
                    .analysis-warning {
                        color: #ff4500;
                        font-weight: bold;
                    }
                    .analysis-normal {
                        color: #2e8b57;
                        font-weight: bold;
                    }
                </style>
            </div>
            
            <div class="ecg-stats">
                <div class="stat-card">
                    <h4>Heart Rate</h4>
                    <div class="stat-value" id="ecgHeartRate">-- bpm</div>
                </div>
                
                <div class="stat-card">
                    <h4>QRS Duration</h4>
                    <div class="stat-value" id="qrsDuration">-- ms</div>
                </div>
                
                <div class="stat-card">
                    <h4>PR Interval</h4>
                    <div class="stat-value" id="prInterval">-- ms</div>
                </div>
                
                <div class="stat-card">
                    <h4>QT Interval</h4>
                    <div class="stat-value" id="qtInterval">-- ms</div>
                </div>
            </div>
            
            <div class="ecg-analysis">
                <h3>ECG Analysis</h3>
                <div class="analysis-result" id="ecgAnalysis">
                    <p>Select a patient to view ECG analysis</p>
                </div>
            </div>
            
            <div class="monitoring-actions">
                <button class="action-btn" onclick="printECG()"><i class="fas fa-print"></i> Print ECG</button>
                <button class="action-btn" onclick="saveECGReport()"><i class="fas fa-save"></i> Save Report</button>
                <button class="action-btn danger" onclick="triggerECGAlert()"><i class="fas fa-exclamation-triangle"></i> Trigger Alert</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to load ECG data directly by patient name
    function loadECGByPatientName(patientName) {
        if (!patientName) {
            console.error('Patient name is required');
            return;
        }
        
        // Show loading indicator
        const ecgChart = document.getElementById('ecgChart');
        ecgChart.innerHTML = '<div class="loading-indicator">Loading ECG data for ' + patientName + '...</div>';
        
        // Fetch ECG data using patient name
        fetch(`/patient-management/api/ecg?patient=${encodeURIComponent(patientName)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch ECG data');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show sample data notice if using default ECG
                const ecgInfoElement = document.getElementById('ecgInfo');
                if (ecgInfoElement) {
                    if (data.is_sample) {
                        ecgInfoElement.innerHTML = '<div class="alert alert-info">Using sample ECG data. No patient-specific ECG available for ' + patientName + '.</div>';
                        ecgInfoElement.style.display = 'block';
                    } else {
                        ecgInfoElement.innerHTML = '<div class="alert alert-success">Using patient-specific ECG data for ' + patientName + '.</div>';
                        ecgInfoElement.style.display = 'block';
                    }
                }
                
                // Render the ECG waveform using Canvas
                renderECGWaveform(data);
                
                // Calculate heart rate from the ECG data
                const heartRate = calculateHeartRate(data.ecg, data.fs);
                document.getElementById('ecgHeartRate').textContent = heartRate + ' bpm';
                
                // For other metrics, we could calculate them from the ECG data
                // but for now we'll use values based on the heart rate
                const qrsDuration = Math.floor(80 + (heartRate > 100 ? -10 : heartRate < 60 ? 10 : 0) + Math.random() * 20);
                const prInterval = Math.floor(120 + (heartRate > 100 ? -20 : heartRate < 60 ? 20 : 0) + Math.random() * 30);
                const qtInterval = Math.floor(350 + (heartRate > 100 ? -30 : heartRate < 60 ? 30 : 0) + Math.random() * 20);
                
                document.getElementById('qrsDuration').textContent = qrsDuration + ' ms';
                document.getElementById('prInterval').textContent = prInterval + ' ms';
                document.getElementById('qtInterval').textContent = qtInterval + ' ms';
                
                // Update the analysis based on the heart rate
                updateECGAnalysis(heartRate);
            })
            .catch(error => {
                console.error('Error loading ECG data:', error);
                ecgChart.innerHTML = `<div class="error-message">Error loading ECG data for ${patientName}: ${error.message}</div>`;
            });
    }
    
    // Function to populate bed type dropdown with available beds
    function populateBedTypeDropdown() {
        fetch('/bed_availability')
            .then(response => response.json())
            .then(data => {
                if (data.beds_by_floor) {
                    const bedTypeDropdown = document.getElementById('bedType');
                    
                    // Clear existing options except the first one
                    while (bedTypeDropdown.options.length > 1) {
                        bedTypeDropdown.remove(1);
                    }
                    
                    // Add available beds to the dropdown
                    Object.keys(data.beds_by_floor).sort().forEach(floor => {
                        data.beds_by_floor[floor].forEach(bed => {
                            if (bed.status === 'available') {
                                const option = document.createElement('option');
                                // Store the exact floor and bed_id as JSON in the value
                                option.value = JSON.stringify({
                                    floor: floor,
                                    bed_id: bed.bed_id,
                                    bed_type: bed.bed_type
                                });
                                // Display a user-friendly description
                                option.textContent = `${bed.bed_type} - Floor ${floor} Bed ${bed.bed_id}`;
                                bedTypeDropdown.appendChild(option);
                            }
                        });
                    });
                    
                    // If no available beds, add a message
                    if (bedTypeDropdown.options.length === 1) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No beds available';
                        option.disabled = true;
                        bedTypeDropdown.appendChild(option);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching bed data for dropdown:', error);
            });
    }

    // Function to load ECG data for the selected patient
    function loadECGData() {
        const patientSelect = document.getElementById('ecgPatient');
        const patientId = patientSelect.value;
        
        if (!patientId) return;
        
        // Get the selected option to access the patient name
        const selectedOption = patientSelect.options[patientSelect.selectedIndex];
        const patientName = selectedOption.dataset.patientName || selectedOption.textContent.split(' (')[0];
        
        // Show loading indicator with patient name
        const ecgChart = document.getElementById('ecgChart');
        ecgChart.innerHTML = '<div class="loading-indicator">Loading ECG data for <strong>' + patientName + '</strong>...</div>';
        
        // Prioritize using patient name for ECG data fetching
        // The patient_id is included as a fallback
        console.log(`Fetching ECG data for patient: ${patientName}`);
        fetch(`/patient-management/api/ecg?patient=${encodeURIComponent(patientName)}&patient_id=${encodeURIComponent(patientId)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch ECG data');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show sample data notice if using default ECG
                const ecgInfoElement = document.getElementById('ecgInfo');
                if (ecgInfoElement) {
                    if (data.is_sample) {
                        ecgInfoElement.innerHTML = '<div class="alert alert-info">Using <strong>sample ECG data</strong>. No patient-specific ECG available for <strong>' + patientName + '</strong>.</div>';
                        ecgInfoElement.style.display = 'block';
                    } else {
                        ecgInfoElement.innerHTML = '<div class="alert alert-success">Using <strong>patient-specific ECG data</strong> for <strong>' + patientName + '</strong>.</div>';
                        ecgInfoElement.style.display = 'block';
                    }
                }
                
                // Render the ECG waveform
                renderECGWaveform(data);
                
                // Calculate heart rate from the ECG data
                const heartRate = calculateHeartRate(data.ecg, data.fs);
                
                // Update ECG stats based on the data
                updateECGStats({
                    heartRate: heartRate,
                    qrsDuration: Math.floor(80 + (heartRate > 100 ? -10 : heartRate < 60 ? 10 : 0) + Math.random() * 20),
                    prInterval: Math.floor(120 + (heartRate > 100 ? -20 : heartRate < 60 ? 20 : 0) + Math.random() * 30),
                    qtInterval: Math.floor(350 + (heartRate > 100 ? -30 : heartRate < 60 ? 30 : 0) + Math.random() * 20)
                });
                
                // Update ECG analysis based on heart rate
                updateECGAnalysis(heartRate);
            })
            .catch(error => {
                console.error(`Error loading ECG data for ${patientName}:`, error);
                ecgChart.innerHTML = `<div class="error-message">Error loading ECG data for <strong>${patientName}</strong>: ${error.message}</div>`;
            });
    }
    
    // Global variables for ECG animation
    let currentECGSpeed = 2;
    let ecgAnimationFrame = null;
    let currentECGData = null;
    let ecgPaused = false;
    
    // Function to update ECG animation speed
    function updateECGSpeed(value) {
        currentECGSpeed = parseFloat(value);
        document.getElementById('ecgSpeedValue').textContent = currentECGSpeed + 'x';
    }
    
    // Function to stop any running ECG animation
    function stopECGAnimation() {
        if (ecgAnimationFrame) {
            cancelAnimationFrame(ecgAnimationFrame);
            ecgAnimationFrame = null;
        }
    }
    
    // Function to render the ECG waveform using Canvas with animation
    function renderECGWaveform(data) {
        // Stop any existing animation
        stopECGAnimation();
        
        // If ECG is paused, just store the data and return
        if (ecgPaused && data.ecg) {
            currentECGData = data.ecg;
            return;
        }
        
        const ecgChart = document.getElementById('ecgChart');
        ecgChart.innerHTML = ''; // Clear previous content
        
        // Create canvas element
        const canvas = document.createElement('canvas');
        canvas.width = ecgChart.clientWidth;
        canvas.height = 200;
        ecgChart.appendChild(canvas);
        
        const ctx = canvas.getContext('2d');
        const ecgData = data.ecg;
        
        // Store the ECG data globally
        currentECGData = ecgData;
        
        // Create a more realistic ECG by adding variations
        const enhancedData = enhanceECGData(ecgData);
        
        // Add grid lines
        drawECGGrid(ctx, canvas.width, canvas.height);
        
        // Set up animation variables
        let position = 0;
        const visiblePoints = Math.min(500, enhancedData.length); // Number of points visible at once
        
        // Calculate scaling factors
        const xStep = canvas.width / visiblePoints;
        const yMiddle = canvas.height / 2;
        const yScale = canvas.height / 4; // Scale to fit in canvas
        
        // Function to draw the current frame of the ECG
        function drawECG() {
            // Clear the canvas (except grid)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Redraw the grid
            drawECGGrid(ctx, canvas.width, canvas.height);
            
            // Draw the ECG line
            ctx.beginPath();
            ctx.strokeStyle = '#00cc00'; // Green color for ECG
            ctx.lineWidth = 2;
            
            // Calculate the starting index based on current position
            const startIdx = Math.floor(position);
            
            // Draw visible portion of the ECG
            for (let i = 0; i < visiblePoints; i++) {
                const dataIdx = (startIdx + i) % enhancedData.length;
                const x = i * xStep;
                const y = yMiddle - (enhancedData[dataIdx] * yScale);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Add a blinking dot to simulate the real-time monitoring
            const lastDataIdx = (startIdx + visiblePoints - 1) % enhancedData.length;
            const lastX = (visiblePoints - 1) * xStep;
            const lastY = yMiddle - (enhancedData[lastDataIdx] * yScale);
            
            ctx.beginPath();
            ctx.arc(lastX, lastY, 3, 0, Math.PI * 2);
            ctx.fillStyle = '#ff0000'; // Red dot
            ctx.fill();
            
            // Update position for next frame based on current speed setting
            position = (position + currentECGSpeed) % enhancedData.length;
            
            // Request next animation frame
            ecgAnimationFrame = requestAnimationFrame(drawECG);
        }
        
        // Start the animation
        drawECG();
        
        // Add cleanup on tab change or when component is unmounted
        const cleanupAnimation = () => {
            stopECGAnimation();
        };
        
        // Clean up animation when switching tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', cleanupAnimation);
        });
        
        // Clean up when the window is unloaded
        window.addEventListener('beforeunload', cleanupAnimation);
    }
    
    // Function to enhance ECG data to make it more realistic
    function enhanceECGData(originalData) {
        // Create a copy of the original data
        const enhancedData = [...originalData];
        
        // Add some randomness to simulate natural variation
        for (let i = 0; i < enhancedData.length; i++) {
            // Add small random variations (5% of the value)
            enhancedData[i] = enhancedData[i] * (1 + (Math.random() * 0.1 - 0.05));
        }
        
        // Add periodic variations to simulate breathing effects
        const breathingCycle = Math.floor(enhancedData.length / 5); // 5 breathing cycles per ECG
        for (let i = 0; i < enhancedData.length; i++) {
            const breathingEffect = Math.sin(i * 2 * Math.PI / breathingCycle) * 0.05;
            enhancedData[i] += breathingEffect;
        }
        
        // For seamless looping, blend the end with the beginning
        const blendPoints = Math.min(50, Math.floor(enhancedData.length / 10));
        for (let i = 0; i < blendPoints; i++) {
            const weight = i / blendPoints;
            enhancedData[enhancedData.length - blendPoints + i] = 
                enhancedData[enhancedData.length - blendPoints + i] * (1 - weight) + 
                enhancedData[i] * weight;
        }
        
        // Add the beginning to the end for seamless looping
        const seamlessPoints = Math.min(100, Math.floor(enhancedData.length / 4));
        enhancedData.push(...enhancedData.slice(0, seamlessPoints));
        
        return enhancedData;
    }
    
    // Function to draw ECG grid
    function drawECGGrid(ctx, width, height) {
        ctx.strokeStyle = 'rgba(200, 200, 200, 0.5)';
        ctx.lineWidth = 0.5;
        
        // Draw horizontal grid lines
        const yStep = height / 10;
        for (let y = 0; y <= height; y += yStep) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
        }
        
        // Draw vertical grid lines
        const xStep = width / 20;
        for (let x = 0; x <= width; x += xStep) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
        }
    }
    
    // Function to update ECG stats
    function updateECGStats(stats) {
        document.getElementById('ecgHeartRate').textContent = `${stats.heartRate} bpm`;
        document.getElementById('qrsDuration').textContent = `${stats.qrsDuration} ms`;
        document.getElementById('prInterval').textContent = `${stats.prInterval} ms`;
        document.getElementById('qtInterval').textContent = `${stats.qtInterval} ms`;
    }
    
    // Function to update ECG analysis
    function updateECGAnalysis(heartRate) {
        let analysis = '';
        let className = '';
        
        if (heartRate < 60) {
            analysis = `<i class="fas fa-exclamation-triangle"></i> Bradycardia detected (${heartRate} BPM). Heart rate below normal range.`;
            className = 'analysis-warning';
        } else if (heartRate > 100) {
            analysis = `<i class="fas fa-exclamation-triangle"></i> Tachycardia detected (${heartRate} BPM). Heart rate above normal range.`;
            className = 'analysis-warning';
        } else {
            analysis = `<i class="fas fa-check-circle"></i> Normal sinus rhythm detected (${heartRate} BPM). Heart rate within normal range.`;
            className = 'analysis-normal';
        }
        
        document.getElementById('ecgAnalysis').innerHTML = `<p class="${className}">${analysis}</p>`;
    }
    
    // Function to initialize ECG monitoring section
    function initializeECGMonitoring() {
        // Populate floor dropdown from beds collection
        fetch('/patient-management/api/ecg-beds')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Get unique floors
                const floors = [...new Set(data.beds.map(bed => bed.floor))];
                
                // Sort floors numerically
                floors.sort((a, b) => parseInt(a) - parseInt(b));
                
                // Populate floor dropdown
                const floorSelect = document.getElementById('ecgFloor');
                
                // Clear existing options except the first one
                while (floorSelect.options.length > 1) {
                    floorSelect.remove(1);
                }
                
                // Add floors
                floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor;
                    option.textContent = `Floor ${floor}`;
                    floorSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading floors:', error);
                // Fallback to static floor list
                const floors = [1, 2, 3, 4, 5];
                const floorSelect = document.getElementById('ecgFloor');
                
                floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor;
                    option.textContent = `Floor ${floor}`;
                    floorSelect.appendChild(option);
                });
            });
    }
    
    // Function to update ECG bed list based on selected floor
    function updateECGRoomList() {
        const floor = document.getElementById('ecgFloor').value;
        const bedSelect = document.getElementById('ecgRoom');
        
        // Clear existing options except the first one
        while (bedSelect.options.length > 1) {
            bedSelect.remove(1);
        }
        
        // Reset patient dropdown
        const patientSelect = document.getElementById('ecgPatient');
        while (patientSelect.options.length > 1) {
            patientSelect.remove(1);
        }
        
        if (!floor) return;
        
        // Fetch beds from the beds collection
        fetch('/patient-management/api/ecg-beds')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Filter beds by floor and occupied status
                const bedsOnFloor = data.beds.filter(bed => {
                    // Handle both string and integer floor values
                    return (bed.floor == floor || 
                           bed.floor === parseInt(floor) || 
                           (bed.floor && floor && bed.floor.toString() === floor.toString())) &&
                           bed.status === 'occupied';
                });
                
                // Sort beds by bed_id
                bedsOnFloor.sort((a, b) => {
                    return a.bed_id.localeCompare(b.bed_id, undefined, {numeric: true});
                });
                
                // Add beds to dropdown
                bedsOnFloor.forEach(bed => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({
                        floor: bed.floor,
                        bed_id: bed.bed_id,
                        bed_type: bed.bed_type
                    });
                    option.textContent = `${bed.bed_type} - Bed ${bed.bed_id}`;
                    bedSelect.appendChild(option);
                });
                
                // If no beds found
                if (bedsOnFloor.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No occupied beds on this floor';
                    option.disabled = true;
                    bedSelect.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error loading beds:', error);
                // Fallback to static bed list
                for (let i = 1; i <= 5; i++) {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({
                        floor: floor,
                        bed_id: `G${floor}-${i.toString().padStart(2, '0')}`,
                        bed_type: 'General'
                    });
                    option.textContent = `General - Bed G${floor}-${i.toString().padStart(2, '0')}`;
                    bedSelect.appendChild(option);
                }
            });
    }
    
    // Function to load ECG patients based on selected bed
    function loadECGPatients() {
        const bedSelect = document.getElementById('ecgRoom');
        const bedValue = bedSelect.value;
        const patientSelect = document.getElementById('ecgPatient');
        
        // Clear existing options except the first one
        while (patientSelect.options.length > 1) {
            patientSelect.remove(1);
        }
        
        // Clear ECG info display
        const ecgInfoElement = document.getElementById('ecgInfo');
        if (ecgInfoElement) {
            ecgInfoElement.style.display = 'none';
        }
        
        if (!bedValue) return;
        
        try {
            // Parse bed information
            const bedInfo = JSON.parse(bedValue);
            const floor = bedInfo.floor;
            const bedId = bedInfo.bed_id;
            
            // Fetch patients in the selected bed
            fetch('/get-admitted-patients')
                .then(response => response.json())
                .then(patients => {
                    // Filter patients by bed information
                    const bedPatients = patients.filter(patient => {
                        // Check if patient has the new bed format
                        if (patient.bed_id && patient.floor) {
                            return patient.bed_id === bedId && 
                                  (patient.floor == floor || patient.floor.toString() === floor.toString());
                        }
                        // Check old format (parsed from bed_type string)
                        else if (patient.bed_type) {
                            // Try to extract bed_id from bed_type string
                            const bedTypeMatch = patient.bed_type.match(/Bed\s+([\w\d-]+)/i);
                            if (bedTypeMatch && bedTypeMatch[1]) {
                                return bedTypeMatch[1] === bedId;
                            }
                        }
                        return false;
                    });
                    
                    if (bedPatients.length > 0) {
                        // Fetch available ECG files
                        fetch('/patient-management/api/available-ecg-files')
                            .then(response => response.json())
                            .then(ecgFilesData => {
                                // Extract the files array from the response
                                const ecgFiles = ecgFilesData.files ? ecgFilesData.files.map(file => file.file_name) : [];
                                bedPatients.forEach(patient => {
                                    const patientNameNormalized = patient.name.replace(/\s+/g, '').toLowerCase();
                                    
                                    // Check for exact match first
                                    const exactMatch = ecgFiles.find(file => {
                                        return file.toLowerCase() === patientNameNormalized;
                                    });
                                    
                                    // Then check for partial match
                                    const partialMatch = !exactMatch && ecgFiles.find(file => {
                                        return file.toLowerCase().includes(patientNameNormalized);
                                    });
                                    
                                    // Use AAMI sample if no match
                                    const sampleFile = !exactMatch && !partialMatch && ecgFiles.find(file => {
                                        return file.toLowerCase().startsWith('aami');
                                    });
                                    
                                    const matchedFile = exactMatch || partialMatch || sampleFile;
                                    const hasEcg = !!matchedFile;
                                    const ecgType = matchedFile ? 
                                        (matchedFile.toLowerCase().startsWith('aami') ? 'sample' : 'patient-specific') : '';
                                    
                                    const option = document.createElement('option');
                                    option.value = patient._id;
                                    
                                    // Add indicator for sample ECG data
                                    const ecgTypeIndicator = hasEcg && ecgType === 'sample' ? ' (Sample ECG)' : 
                                                            !hasEcg ? ' - No ECG' : '';
                                    option.textContent = `${patient.name} (${patient.age}/${patient.gender})${ecgTypeIndicator}`;
                                    
                                    option.dataset.patientName = patient.name;
                                    if (matchedFile) {
                                        option.dataset.ecgFile = matchedFile;
                                        option.dataset.ecgType = ecgType;
                                    }
                                    patientSelect.appendChild(option);
                                });
                                
                                // Automatically select the patient if there's only one
                                if (bedPatients.length === 1) {
                                    patientSelect.value = bedPatients[0]._id;
                                    // Trigger the change event to load ECG data
                                    const event = new Event('change');
                                    patientSelect.dispatchEvent(event);
                                }
                            })
                            .catch(error => {
                                console.error('Error checking ECG files:', error);
                                // Show all patients without ECG status
                                bedPatients.forEach(patient => {
                                    const option = document.createElement('option');
                                    option.value = patient._id;
                                    option.textContent = `${patient.name} (${patient.age}/${patient.gender}) - ECG status unknown`;
                                    option.dataset.patientName = patient.name;
                                    option.dataset.patientId = patient._id;
                                    patientSelect.appendChild(option);
                                });
                                
                                // Show error message
                                const ecgInfoElement = document.getElementById('ecgInfo');
                                if (ecgInfoElement) {
                                    ecgInfoElement.innerHTML = '<div class="alert alert-warning">Unable to check ECG file availability. Some features may be limited.</div>';
                                    ecgInfoElement.style.display = 'block';
                                }
                            });
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No patients found in this bed';
                        option.disabled = true;
                        patientSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading patients:', error);
                });
        } catch (error) {
            console.error('Error parsing bed information:', error);
        }
    }
    
    // Functions for ECG actions
    function printECG() {
        alert('Printing ECG...');
        // In a real app, this would generate a printable report
    }
    
    function saveECGReport() {
        alert('Saving ECG report...');
        // In a real app, this would save the report to the database
    }
    
    function triggerECGAlert() {
        if (confirm('Are you sure you want to trigger an ECG alert? This will notify the medical team.')) {
            alert('ECG alert triggered. Medical team has been notified.');
            // In a real app, this would send notifications to the medical team
        }
    }
    
    // Health Monitoring System - Dynamic Vital Signs
    // Global variables for health monitoring
    let healthMonitor_interval = null;
    let healthMonitor_patientData = {};
    let healthMonitor_vitalsChart = null;
    let healthMonitor_vitalsHistory = {
        labels: [],
        heartRate: [],
        oxygen: [],
        temperature: [],
        systolic: [],
        diastolic: []
    };

    // Initialize health monitoring
    function initializeHealthMonitoring() {
        // Initialize Chart.js for vitals monitoring if it exists
        if (document.getElementById('vitalsChartCanvas')) {
            initializeVitalsChart();
        }
        
        // Generate dummy data for all admitted patients
        fetchAdmittedPatientsForMonitoring();
        
        console.log('Health monitoring initialized');
    }
    
    // Initialize the vitals chart using Chart.js
    function initializeVitalsChart() {
        const ctx = document.getElementById('vitalsChartCanvas').getContext('2d');
        healthMonitor_vitalsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Heart Rate',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Oxygen',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Temperature',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Systolic BP',
                        data: [],
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Diastolic BP',
                        data: [],
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });
    }
    
    // Fetch admitted patients and generate dummy vitals data for each
    async function fetchAdmittedPatientsForMonitoring() {
        try {
            const response = await fetch('/get-admitted-patients');
            if (!response.ok) {
                throw new Error('Failed to fetch admitted patients');
            }
            
            const patients = await response.json();
            
            // Generate dummy vitals data for each patient
            patients.forEach(patient => {
                healthMonitor_patientData[patient._id] = generatePatientVitals(patient);
            });
            
            // Add some dummy patients if none are admitted
            if (patients.length === 0) {
                const dummyPatients = [
                    { _id: 'dummy1', name: 'John Doe', age: 45, gender: 'M' },
                    { _id: 'dummy2', name: 'Jane Smith', age: 62, gender: 'F' }
                ];
                
                dummyPatients.forEach(patient => {
                    healthMonitor_patientData[patient._id] = generatePatientVitals(patient);
                });
            }
            
            console.log('Initialized vitals data for patients:', Object.keys(healthMonitor_patientData).length);
        } catch (error) {
            console.error('Error fetching patients for monitoring:', error);
            
            // Create dummy patients in case of error
            const dummyPatients = [
                { _id: 'dummy1', name: 'John Doe', age: 45, gender: 'M' },
                { _id: 'dummy2', name: 'Jane Smith', age: 62, gender: 'F' }
            ];
            
            dummyPatients.forEach(patient => {
                healthMonitor_patientData[patient._id] = generatePatientVitals(patient);
            });
        }
    }
    
    // Generate baseline vitals for a patient based on age and gender
    function generatePatientVitals(patient) {
        // Generate baseline vitals based on patient age and gender
        const age = patient.age || Math.floor(Math.random() * 80) + 20;
        const gender = patient.gender || (Math.random() > 0.5 ? 'M' : 'F');
        
        // Baseline values (these would be different for each patient in a real system)
        const baseHeartRate = age < 30 ? 70 : age < 60 ? 75 : 80;
        const baseOxygen = 97;
        const baseTemperature = 36.8;
        const baseSystolic = gender === 'M' ? 120 : 115;
        const baseDiastolic = gender === 'M' ? 80 : 75;
        
        // Add some randomness to make each patient unique
        const patientFactor = Math.random() * 0.2 + 0.9; // 0.9 to 1.1
        
        return {
            baseHeartRate: baseHeartRate * patientFactor,
            baseOxygen: baseOxygen * patientFactor,
            baseTemperature: baseTemperature * patientFactor,
            baseSystolic: baseSystolic * patientFactor,
            baseDiastolic: baseDiastolic * patientFactor,
            // Current values start at the baseline
            heartRate: baseHeartRate * patientFactor,
            oxygen: baseOxygen * patientFactor,
            temperature: baseTemperature * patientFactor,
            systolic: baseSystolic * patientFactor,
            diastolic: baseDiastolic * patientFactor,
            // Trend direction (1 = up, -1 = down, 0 = stable)
            trend: {
                heartRate: 0,
                oxygen: 0,
                temperature: 0,
                systolic: 0,
                diastolic: 0
            },
            // How many updates before changing trend direction
            trendDuration: {
                heartRate: Math.floor(Math.random() * 5) + 3,
                oxygen: Math.floor(Math.random() * 5) + 3,
                temperature: Math.floor(Math.random() * 5) + 3,
                systolic: Math.floor(Math.random() * 5) + 3,
                diastolic: Math.floor(Math.random() * 5) + 3
            }
        };
    }
    
    // Update room list based on selected floor
    function healthMonitor_updateRoomList() {
        const floorSelect = document.getElementById('monitoringFloor');
        const roomSelect = document.getElementById('monitoringRoom');
        const floor = floorSelect.value;
        
        // Clear existing options except the first one
        while (roomSelect.options.length > 1) {
            roomSelect.remove(1);
        }
        
        // Clear patient select as well
        const patientSelect = document.getElementById('monitoringPatient');
        while (patientSelect.options.length > 1) {
            patientSelect.remove(1);
        }
        
        if (!floor) return;
        
        // Add rooms for the selected floor
        for (let i = 1; i <= 10; i++) {
            const roomNumber = i.toString().padStart(2, '0');
            const option = document.createElement('option');
            option.value = `${floor}-${roomNumber}`;
            option.textContent = `Room ${roomNumber}`;
            roomSelect.appendChild(option);
        }
    }
    
    // Load patients based on selected room
    function healthMonitor_loadPatients() {
        const roomSelect = document.getElementById('monitoringRoom');
        const room = roomSelect.value;
        const patientSelect = document.getElementById('monitoringPatient');
        
        // Clear existing options except the first one
        while (patientSelect.options.length > 1) {
            patientSelect.remove(1);
        }
        
        if (!room) return;
        
        // Extract floor and room number from the room value (format: "floor-room")
        const [floor, roomNumber] = room.split('-');
        
        // Fetch patients in the selected room
        fetch('/get-admitted-patients')
            .then(response => response.json())
            .then(allPatients => {
                // Filter patients by room
                // In a real system, you would have a proper room field in the patient data
                // For now, we'll just assign patients randomly to rooms
                const roomPatients = allPatients.filter((_, index) => {
                    // Assign each patient to a room based on their index
                    const patientFloor = Math.floor(index / 10) + 1;
                    const patientRoom = (index % 10) + 1;
                    return patientFloor.toString() === floor && patientRoom.toString().padStart(2, '0') === roomNumber;
                });
                
                if (roomPatients.length > 0) {
                    roomPatients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient._id;
                        option.textContent = `${patient.name} (${patient.age}/${patient.gender})`;
                        patientSelect.appendChild(option);
                    });
                } else {
                    // If no patients found, add some dummy patients for demo
                    const dummyPatients = [
                        { _id: 'dummy1', name: 'John Doe', age: 45, gender: 'M' },
                        { _id: 'dummy2', name: 'Jane Smith', age: 62, gender: 'F' }
                    ];
                    
                    dummyPatients.forEach(patient => {
                        // Initialize vitals data for dummy patients if not already done
                        if (!healthMonitor_patientData[patient._id]) {
                            healthMonitor_patientData[patient._id] = generatePatientVitals(patient);
                        }
                        
                        const option = document.createElement('option');
                        option.value = patient._id;
                        option.textContent = `${patient.name} (${patient.age}/${patient.gender})`;
                        patientSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading patients:', error);
                
                // Add dummy patients in case of error
                const dummyPatients = [
                    { _id: 'dummy1', name: 'John Doe', age: 45, gender: 'M' },
                    { _id: 'dummy2', name: 'Jane Smith', age: 62, gender: 'F' }
                ];
                
                dummyPatients.forEach(patient => {
                    // Initialize vitals data for dummy patients if not already done
                    if (!healthMonitor_patientData[patient._id]) {
                        healthMonitor_patientData[patient._id] = generatePatientVitals(patient);
                    }
                    
                    const option = document.createElement('option');
                    option.value = patient._id;
                    option.textContent = `${patient.name} (${patient.age}/${patient.gender})`;
                    patientSelect.appendChild(option);
                });
            });
    }
    
    // Start monitoring the selected patient
    function healthMonitor_startMonitoring(patientId) {
        // Clear any existing monitoring interval
        if (healthMonitor_interval) {
            clearInterval(healthMonitor_interval);
            healthMonitor_interval = null;
        }
        
        if (!patientId) {
            // Reset the vitals display
            document.getElementById('heartRateValue').textContent = '-- bpm';
            document.getElementById('heartRateStatus').textContent = 'Normal';
            document.getElementById('oxygenValue').textContent = '-- %';
            document.getElementById('oxygenStatus').textContent = 'Normal';
            document.getElementById('temperatureValue').textContent = '-- C';
            document.getElementById('temperatureStatus').textContent = 'Normal';
            document.getElementById('bpValue').textContent = '--/-- mmHg';
            document.getElementById('bpStatus').textContent = 'Normal';
            
            // Reset the chart
            healthMonitor_resetVitalsChart();
            return;
        }
        
        // Initialize the patient's vitals history
        healthMonitor_resetVitalsHistory();
        
        // Start monitoring the selected patient
        healthMonitor_interval = setInterval(() => {
            healthMonitor_updatePatientVitals(patientId);
        }, 1000); // Update every second
        
        // Initial update
        healthMonitor_updatePatientVitals(patientId);
    }
    
    // Reset the vitals history
    function healthMonitor_resetVitalsHistory() {
        healthMonitor_vitalsHistory = {
            labels: [],
            heartRate: [],
            oxygen: [],
            temperature: [],
            systolic: [],
            diastolic: []
        };
        
        // Reset the chart
        healthMonitor_resetVitalsChart();
    }
    
    // Reset the vitals chart
    function healthMonitor_resetVitalsChart() {
        if (healthMonitor_vitalsChart) {
            healthMonitor_vitalsChart.data.labels = [];
            healthMonitor_vitalsChart.data.datasets[0].data = []; // Heart Rate
            healthMonitor_vitalsChart.data.datasets[1].data = []; // Oxygen
            healthMonitor_vitalsChart.data.datasets[2].data = []; // Temperature
            healthMonitor_vitalsChart.data.datasets[3].data = []; // Systolic BP
            healthMonitor_vitalsChart.data.datasets[4].data = []; // Diastolic BP
            healthMonitor_vitalsChart.update();
        }
    }
    
    // Update the patient's vitals
    function healthMonitor_updatePatientVitals(patientId) {
        // Get the patient's vitals data
        const vitals = healthMonitor_patientData[patientId];
        if (!vitals) {
            console.error('No vitals data found for patient:', patientId);
            return;
        }
        
        // Update the trend durations and directions
        healthMonitor_updateVitalsTrends(vitals);
        
        // Calculate new vitals values based on trends
        healthMonitor_calculateNewVitals(vitals);
        
        // Update the UI with the new values
        healthMonitor_updateVitalsUI(vitals);
        
        // Update the history and chart
        healthMonitor_updateVitalsHistory(vitals);
    }
    
    // Update the trends for each vital sign
    function healthMonitor_updateVitalsTrends(vitals) {
        // For each vital sign, update the trend duration and direction
        ['heartRate', 'oxygen', 'temperature', 'systolic', 'diastolic'].forEach(vital => {
            // Decrease the trend duration
            vitals.trendDuration[vital]--;
            
            // If the trend duration is zero, change the trend direction
            if (vitals.trendDuration[vital] <= 0) {
                // Random trend direction (-1, 0, or 1)
                vitals.trend[vital] = Math.floor(Math.random() * 3) - 1;
                // New random duration
                vitals.trendDuration[vital] = Math.floor(Math.random() * 5) + 3;
            }
        });
    }
    
    // Calculate new vitals values based on trends
    function healthMonitor_calculateNewVitals(vitals) {
        // Calculate new heart rate
        const heartRateChange = (Math.random() * 2 - 0.5) + (vitals.trend.heartRate * 0.5);
        vitals.heartRate = Math.max(40, Math.min(180, vitals.heartRate + heartRateChange));
        
        // Calculate new oxygen level
        const oxygenChange = (Math.random() * 0.4 - 0.1) + (vitals.trend.oxygen * 0.2);
        vitals.oxygen = Math.max(85, Math.min(100, vitals.oxygen + oxygenChange));
        
        // Calculate new temperature
        const temperatureChange = (Math.random() * 0.2 - 0.05) + (vitals.trend.temperature * 0.1);
        vitals.temperature = Math.max(35, Math.min(40, vitals.temperature + temperatureChange));
        
        // Calculate new blood pressure
        const systolicChange = (Math.random() * 4 - 1) + (vitals.trend.systolic * 1);
        vitals.systolic = Math.max(80, Math.min(200, vitals.systolic + systolicChange));
        
        const diastolicChange = (Math.random() * 2 - 0.5) + (vitals.trend.diastolic * 0.5);
        vitals.diastolic = Math.max(40, Math.min(120, vitals.diastolic + diastolicChange));
    }
    
    // Update the UI with the new vitals values
    function healthMonitor_updateVitalsUI(vitals) {
        // Update heart rate
        const heartRateValue = Math.round(vitals.heartRate);
        document.getElementById('heartRateValue').textContent = `${heartRateValue} bpm`;
        
        let heartRateStatus = 'Normal';
        let heartRateClass = '';
        if (heartRateValue < 60) {
            heartRateStatus = 'Bradycardia';
            heartRateClass = 'warning';
        } else if (heartRateValue > 100) {
            heartRateStatus = 'Tachycardia';
            heartRateClass = heartRateValue > 120 ? 'danger' : 'warning';
        }
        document.getElementById('heartRateStatus').textContent = heartRateStatus;
        document.getElementById('heartRateStatus').className = `vital-status ${heartRateClass}`;
        
        // Update oxygen level
        const oxygenValue = Math.round(vitals.oxygen);
        document.getElementById('oxygenValue').textContent = `${oxygenValue} %`;
        
        let oxygenStatus = 'Normal';
        let oxygenClass = '';
        if (oxygenValue < 90) {
            oxygenStatus = 'Hypoxemia';
            oxygenClass = oxygenValue < 85 ? 'danger' : 'warning';
        }
        document.getElementById('oxygenStatus').textContent = oxygenStatus;
        document.getElementById('oxygenStatus').className = `vital-status ${oxygenClass}`;
        
        // Update temperature
        const temperatureValue = vitals.temperature.toFixed(1);
        document.getElementById('temperatureValue').textContent = `${temperatureValue} C`;
        
        let temperatureStatus = 'Normal';
        let temperatureClass = '';
        if (vitals.temperature < 36) {
            temperatureStatus = 'Hypothermia';
            temperatureClass = vitals.temperature < 35 ? 'danger' : 'warning';
        } else if (vitals.temperature > 37.5) {
            temperatureStatus = 'Fever';
            temperatureClass = vitals.temperature > 38.5 ? 'danger' : 'warning';
        }
        document.getElementById('temperatureStatus').textContent = temperatureStatus;
        document.getElementById('temperatureStatus').className = `vital-status ${temperatureClass}`;
        
        // Update blood pressure
        const systolicValue = Math.round(vitals.systolic);
        const diastolicValue = Math.round(vitals.diastolic);
        document.getElementById('bpValue').textContent = `${systolicValue}/${diastolicValue} mmHg`;
        
        let bpStatus = 'Normal';
        let bpClass = '';
        if (systolicValue > 140 || diastolicValue > 90) {
            bpStatus = 'Hypertension';
            bpClass = (systolicValue > 160 || diastolicValue > 100) ? 'danger' : 'warning';
        } else if (systolicValue < 90 || diastolicValue < 60) {
            bpStatus = 'Hypotension';
            bpClass = (systolicValue < 80 || diastolicValue < 50) ? 'danger' : 'warning';
        }
        document.getElementById('bpStatus').textContent = bpStatus;
        document.getElementById('bpStatus').className = `vital-status ${bpClass}`;
    }
    
    // Update the vitals history and chart
    function healthMonitor_updateVitalsHistory(vitals) {
        // Add current time as label
        const now = new Date();
        const timeLabel = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        
        // Add new values to the history
        healthMonitor_vitalsHistory.labels.push(timeLabel);
        healthMonitor_vitalsHistory.heartRate.push(Math.round(vitals.heartRate));
        healthMonitor_vitalsHistory.oxygen.push(Math.round(vitals.oxygen));
        healthMonitor_vitalsHistory.temperature.push(parseFloat(vitals.temperature.toFixed(1)));
        healthMonitor_vitalsHistory.systolic.push(Math.round(vitals.systolic));
        healthMonitor_vitalsHistory.diastolic.push(Math.round(vitals.diastolic));
        
        // Keep only the last 60 values (1 minute of data)
        if (healthMonitor_vitalsHistory.labels.length > 60) {
            healthMonitor_vitalsHistory.labels.shift();
            healthMonitor_vitalsHistory.heartRate.shift();
            healthMonitor_vitalsHistory.oxygen.shift();
            healthMonitor_vitalsHistory.temperature.shift();
            healthMonitor_vitalsHistory.systolic.shift();
            healthMonitor_vitalsHistory.diastolic.shift();
        }
        
        // Update the chart
        healthMonitor_updateVitalsChart();
    }
    
    // Update the vitals chart with the latest data
    function healthMonitor_updateVitalsChart() {
        if (!healthMonitor_vitalsChart) return;
        
        // Update chart data
        healthMonitor_vitalsChart.data.labels = healthMonitor_vitalsHistory.labels;
        healthMonitor_vitalsChart.data.datasets[0].data = healthMonitor_vitalsHistory.heartRate;
        healthMonitor_vitalsChart.data.datasets[1].data = healthMonitor_vitalsHistory.oxygen;
        healthMonitor_vitalsChart.data.datasets[2].data = healthMonitor_vitalsHistory.temperature;
        healthMonitor_vitalsChart.data.datasets[3].data = healthMonitor_vitalsHistory.systolic;
        healthMonitor_vitalsChart.data.datasets[4].data = healthMonitor_vitalsHistory.diastolic;
        
        // Update the chart
        healthMonitor_vitalsChart.update();
    }
    
    // Create a daily report for the selected patient
    function healthMonitor_createDailyReport() {
        // Get the selected patient
        const patientSelect = document.getElementById('monitoringPatient');
        const patientId = patientSelect.value;
        
        if (!patientId) {
            alert('Please select a patient first');
            return;
        }
        
        // Get the patient name
        const patientName = patientSelect.options[patientSelect.selectedIndex].textContent;
        
        // Get the current vitals
        const vitals = healthMonitor_patientData[patientId];
        
        // Redirect to the daily report tab with pre-filled values
        openTab('patientsDailyReport');
        
        // Fill in the form with the current vitals
        document.getElementById('reportPatient').value = patientId;
        document.getElementById('reportDate').valueAsDate = new Date();
        document.getElementById('bloodPressure').value = `${Math.round(vitals.systolic)}/${Math.round(vitals.diastolic)}`;
        document.getElementById('heartRate').value = Math.round(vitals.heartRate);
        document.getElementById('temperature').value = (vitals.temperature * 9/5 + 32).toFixed(1); // Convert to Fahrenheit
        document.getElementById('oxygenLevel').value = Math.round(vitals.oxygen);
        
        // Set focus to the glucose level field
        document.getElementById('glucoseLevel').focus();
        
        alert(`Daily report started for ${patientName}. Please complete the remaining fields.`);
    }
    
    // View the patient's history
    function healthMonitor_viewPatientHistory() {
        // Get the selected patient
        const patientSelect = document.getElementById('monitoringPatient');
        const patientId = patientSelect.value;
        
        if (!patientId) {
            alert('Please select a patient first');
            return;
        }
        
        // In a real system, this would redirect to a patient history page
        // For now, just show an alert with the current vitals history
        alert('Patient history feature is under development. This would show the patient\'s historical vitals data.');
    }
    
    // Trigger an alert for the selected patient
    function healthMonitor_triggerAlert() {
        // Get the selected patient
        const patientSelect = document.getElementById('monitoringPatient');
        const patientId = patientSelect.value;
        
        if (!patientId) {
            alert('Please select a patient first');
            return;
        }
        
        // Get the patient name
        const patientName = patientSelect.options[patientSelect.selectedIndex].textContent;
        
        // In a real system, this would trigger an alert to the medical staff
        alert(`MEDICAL ALERT: Critical condition detected for ${patientName}. Medical staff has been notified.`);
    }

    // Function to load ECG data directly by patient name
    function loadECGByPatientName(patientName) {
        if (!patientName) {
            console.error('Patient name is required');
            return;
        }
        
        // Show loading indicator with patient name
        const ecgChart = document.getElementById('ecgChart');
        if (ecgChart) {
            ecgChart.innerHTML = '<div class="loading-indicator">Loading ECG data for <strong>' + patientName + '</strong>...</div>';
        }
        
        // Fetch ECG data directly using the patient name
        console.log(`Fetching ECG data for patient name: ${patientName}`);
        fetch(`/patient-management/api/ecg?patient=${encodeURIComponent(patientName)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch ECG data');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show sample data notice if using default ECG
                const ecgInfoElement = document.getElementById('ecgInfo');
                if (ecgInfoElement) {
                    if (data.is_sample) {
                        ecgInfoElement.innerHTML = '<div class="alert alert-info">Using <strong>sample ECG data</strong>. No patient-specific ECG available for <strong>' + patientName + '</strong>.</div>';
                        ecgInfoElement.style.display = 'block';
                    } else {
                        ecgInfoElement.innerHTML = '<div class="alert alert-success">Using <strong>patient-specific ECG data</strong> for <strong>' + patientName + '</strong>.</div>';
                        ecgInfoElement.style.display = 'block';
                    }
                }
                
                // Render the ECG waveform using Canvas
                renderECGWaveform(data);
                
                // Calculate heart rate from the ECG data
                const heartRate = calculateHeartRate(data.ecg, data.fs);
                
                // Update ECG stats based on the heart rate
                if (document.getElementById('ecgHeartRate')) {
                    document.getElementById('ecgHeartRate').textContent = heartRate + ' bpm';
                }
                
                // For other metrics, we could calculate them from the ECG data
                // but for now we'll use values based on the heart rate
                const qrsDuration = Math.floor(80 + (heartRate > 100 ? -10 : heartRate < 60 ? 10 : 0) + Math.random() * 20);
                const prInterval = Math.floor(120 + (heartRate > 100 ? -20 : heartRate < 60 ? 20 : 0) + Math.random() * 30);
                const qtInterval = Math.floor(350 + (heartRate > 100 ? -30 : heartRate < 60 ? 30 : 0) + Math.random() * 20);
                
                if (document.getElementById('qrsDuration')) {
                    document.getElementById('qrsDuration').textContent = qrsDuration + ' ms';
                }
                if (document.getElementById('prInterval')) {
                    document.getElementById('prInterval').textContent = prInterval + ' ms';
                }
                if (document.getElementById('qtInterval')) {
                    document.getElementById('qtInterval').textContent = qtInterval + ' ms';
                }
                
                // Update the analysis based on the heart rate
                updateECGAnalysis(heartRate);
            })
            .catch(error => {
                console.error(`Error loading ECG data for ${patientName}:`, error);
                if (ecgChart) {
                    ecgChart.innerHTML = `<div class="error-message">Error loading ECG data for <strong>${patientName}</strong>: ${error.message}</div>`;
                }
            });
    }
    
    // Initialize everything when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Check if functions exist before calling them
        if (typeof initializeDashboard === 'function') {
            initializeDashboard();
        }
        
        if (typeof initializeSlotsTabsNavigation === 'function') {
            initializeSlotsTabsNavigation();
        }
        
        if (typeof initializeBedView === 'function') {
            initializeBedView();
        }
        
        if (typeof initializeRBAC === 'function') {
            initializeRBAC();
        }
        
        // Populate bed type dropdown
        populateBedTypeDropdown();
        
        // Initialize health monitoring
        initializeHealthMonitoring();
        
        // Initialize ECG monitoring
        initializeECGMonitoring();
    });

    // Function to toggle ECG animation pause state
    function toggleECGPause() {
        const pauseBtn = document.getElementById('ecgPauseBtn');
        
        if (ecgPaused) {
            // Resume animation
            ecgPaused = false;
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            
            // If we have ECG data, restart the animation
            if (currentECGData) {
                renderECGWaveform({ ecg: currentECGData });
            }
        } else {
            // Pause animation
            ecgPaused = true;
            pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
            
            // Stop the animation
            stopECGAnimation();
        }
    }
</script>
</body>
</html>
